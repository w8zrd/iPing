import{u as le,a as de,b as ce,r as l,c as me,s as c,l as n,j as s}from"./index-B988mT6b.js";import{M as ue,N as fe}from"./Navigation-C_mdfttj.js";import{H as xe}from"./Header-rqexykfP.js";import{u as ge}from"./use-toast-BhhiqXJo.js";import{P as Q}from"./textParser-FWV9AtS2.js";import{X as pe,C as Z}from"./x-BJs0uyLL.js";import{I as he,S as be}from"./send-DqMZRnb4.js";import{U as ve}from"./user-plus-LS4DgQCx.js";import{c as R}from"./createLucideIcon-C40F9rup.js";import{H as we}from"./heart-Cm-DqPFs.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=R("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=R("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=R("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),qe=()=>{const m=le();de();const[S,$]=ce(),A=l.useRef({}),[T,F]=l.useState(null),[D,g]=l.useState([]),[_,ee]=l.useState([]),[b,U]=l.useState(""),[M,I]=l.useState(!1),[v,P]=l.useState(null),[p,z]=l.useState({}),[E,V]=l.useState(null),[L,Y]=l.useState(!1),[h,q]=l.useState(null),{toast:f}=ge(),{user:a}=me(),se=async e=>{if(!a)return;const{error:t}=await c.from("pings").delete().eq("id",e);t?n.error("Error deleting ping",t,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):(g(i=>i.filter(o=>o.id!==e)),f({title:"Ping deleted!",description:"Your ping has been removed."}))};l.useEffect(()=>{w()},[]);const w=async()=>{const{data:e,error:t}=await c.from("pings").select(`
        *,
        profiles!pings_user_id_fkey(id, username, display_name, verified),
        likes(id, user_id),
        comments(
          id,
          user_id,
          content,
          created_at,
          profiles!comments_user_id_fkey(id, username, display_name, verified)
        )
      `).order("created_at",{ascending:!1});!t&&e?(n.info("Pings fetched successfully",{data:e}),g(e)):n.error("Error fetching pings",t,{userMessage:"Failed to fetch pings. Please try again.",showToast:!0})};l.useEffect(()=>{const e=c.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},t=>{n.debug("Realtime INSERT received",{new:t.new}),g(i=>[t.new,...i])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},t=>{n.debug("Realtime UPDATE received",{new:t.new}),t.new.views!==void 0?g(i=>i.map(o=>o.id===t.new.id?{...o,views:t.new.views}:o)):(n.info("Other ping update, refetching all pings."),w())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},t=>{n.debug("Realtime DELETE received",{oldId:t.old.id}),g(i=>i.filter(o=>o.id!==t.old.id))}).subscribe();return()=>{c.removeChannel(e)}},[]),l.useEffect(()=>{const e=S.get("ping"),t=S.get("openComments")==="true";e&&(F(e),setTimeout(()=>{const i=A.current[e];i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),t&&P(e))},100))},[S,F,P]),l.useEffect(()=>{const e=()=>{T&&(F(null),$({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[T,$]);const te=e=>{var i;const t=(i=e.target.files)==null?void 0:i[0];if(t){const o=new FileReader;o.onloadend=()=>{q(o.result),n.debug("Image loaded for ping preview")},o.readAsDataURL(t)}},re=async()=>{if(!a){m("/auth");return}if(!(!b.trim()&&!h)){I(!0),n.debug("Home.tsx: Attempting to create new ping",{newPing:b,pingImage:h});try{const{error:e}=await c.from("pings").insert({user_id:a.id,content:b,image_url:h||void 0});e?n.error("Home.tsx: Error creating ping",e,{userMessage:"Failed to ping. Please try again.",showToast:!0}):(n.info("Home.tsx: Ping created successfully."),U(""),q(null),f({title:"Pinged!",description:"Your ping is now live"}),w())}catch(e){n.error("Home.tsx: Unexpected error creating ping",e,{userMessage:"An unexpected error occurred while creating ping.",showToast:!0})}finally{I(!1)}}},ie=async e=>{var o,u,y;if(!a){m("/auth");return}const t=D.find(d=>d.id===e);if((o=t==null?void 0:t.likes)==null?void 0:o.some(d=>d.user_id===a.id)){n.debug("Home.tsx: User unliking ping",{pingId:e});const d=(y=(u=t==null?void 0:t.likes)==null?void 0:u.find(C=>C.user_id===a.id))==null?void 0:y.id,{error:j}=await c.from("likes").delete().eq("id",d);j&&n.error("Home.tsx: Error unliking ping",j)}else{n.debug("Home.tsx: User liking ping",{pingId:e});const{error:d}=await c.from("likes").insert({user_id:a.id,post_id:e});d&&n.error("Home.tsx: Error liking ping",d)}w()},B=async e=>{var o;if(!a){m("/auth");return}const t=(o=p[e])==null?void 0:o.trim();if(!t)return;n.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:t});const{error:i}=await c.from("comments").insert({user_id:a.id,ping_id:e,content:t});i?n.error("Home.tsx: Error adding comment",i,{userMessage:"Failed to add comment",showToast:!0}):n.info("Home.tsx: Comment added successfully to ping",{pingId:e}),i?f({title:"Error",description:"Failed to add comment",variant:"destructive"}):(z({...p,[e]:""}),f({title:"Comment added!",description:"Your comment is now visible"}),w())},ne=async(e,t)=>{if(!a){m("/auth");return}if(_.includes(e))return;n.debug("Home.tsx: Attempting to send friend request",{from:a.id,to:e});const{error:i}=await c.from("friend_requests").insert({from_user_id:a.id,to_user_id:e});i?n.error("Home.tsx: Error sending friend request",i,{userMessage:"Failed to send friend request."}):n.info("Home.tsx: Friend request sent successfully."),i||(ee([..._,e]),f({title:"Friend request sent!",description:`Request sent to ${t}`}))},ae=e=>{P(v===e?null:e)},oe=async e=>{var o;const t=`${window.location.origin}/?ping=${e.id}`,i=`Check out this ping from ${(o=e.profiles)==null?void 0:o.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:i,url:t})}catch(u){u.name!=="AbortError"&&(n.error("Home.tsx: Error sharing ping",u,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(t),f({title:"Link copied!",description:"Ping link copied to clipboard"}))}else navigator.clipboard.writeText(t),f({title:"Link copied!",description:"Ping link copied to clipboard"})};return s.jsxs("div",{className:"min-h-screen pb-32",children:[s.jsx("div",{className:E||L?"blur-sm pointer-events-none":"",children:s.jsx(xe,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${L?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:b,onChange:e=>U(e.target.value),onFocus:()=>Y(!0),onBlur:()=>Y(!1),className:"min-h-[100px] rounded-2xl border-border/50 resize-none focus-visible:ring-0 focus-visible:ring-offset-0 focus-visible:border-primary transition-apple mb-4 p-2 w-full bg-transparent"}),h&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:h,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>q(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(pe,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:te,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple",onClick:e=>{var t;e.preventDefault(),(t=e.currentTarget.previousElementSibling)==null||t.click()},children:[s.jsx(he,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:re,disabled:M||!b.trim()&&!h,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 font-semibold transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:M?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:D.map((e,t)=>{var i,o,u,y,d,j,C,K,O,W,X;return s.jsxs("div",{ref:r=>A.current[e.id]=r,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${E&&E!==e.id||L?"blur-sm pointer-events-none":""} ${T===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${t*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>{var r;return m(`/profile/${(r=e.profiles)==null?void 0:r.username}`)},className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:((o=(i=e.profiles)==null?void 0:i.display_name)==null?void 0:o.charAt(0).toUpperCase())||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>{var r;return m(`/profile/${(r=e.profiles)==null?void 0:r.username}`)},className:"font-semibold hover:text-primary transition-apple",children:(u=e.profiles)==null?void 0:u.display_name}),((y=e.profiles)==null?void 0:y.verified)&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(Z,{className:"h-3 w-3 text-white stroke-2"})})]}),a&&e.user_id!==a.id&&s.jsxs("button",{onClick:()=>{var r;return ne(e.user_id,((r=e.profiles)==null?void 0:r.display_name)||"")},disabled:_.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(ve,{className:"h-3 w-3 mr-1"}),_.includes(e.user_id)?"Requested":"Add"]}),e.user_id===(a==null?void 0:a.id)&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>P(v===e.id?null:e.id),children:s.jsx(ye,{className:"h-4 w-4"})}),v===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>se(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",(d=e.profiles)==null?void 0:d.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(Q,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>ie(e.id),className:`flex items-center gap-2 transition-apple group ${(j=e.likes)!=null&&j.some(r=>r.user_id===(a==null?void 0:a.id))?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(we,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${(C=e.likes)!=null&&C.some(r=>r.user_id===(a==null?void 0:a.id))?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:((K=e.likes)==null?void 0:K.length)||0})]}),s.jsxs("button",{onClick:async()=>{const r=v!==e.id;if(ae(e.id),r){n.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:N}=await c.rpc("increment_ping_views",{_ping_id:e.id});N?n.error("Home.tsx: Error incrementing ping views",N):(n.info("Home.tsx: Ping views incremented successfully",{pingId:e.id}),g(H=>H.map(x=>x.id===e.id?{...x,views:x.views+1}:x)))}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(ue,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:((O=e.comments)==null?void 0:O.length)||0})]}),s.jsx("button",{onClick:()=>oe(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(Ne,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(je,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),v===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(r=>{var N,H,x,G,J;return s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>{var k;return m(`/profile/${(k=r.profiles)==null?void 0:k.username}`)},className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:((H=(N=r.profiles)==null?void 0:N.display_name)==null?void 0:H.charAt(0).toUpperCase())||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>{var k;return m(`/profile/${(k=r.profiles)==null?void 0:k.username}`)},className:"font-semibold text-sm hover:text-primary transition-apple",children:(x=r.profiles)==null?void 0:x.display_name}),((G=r.profiles)==null?void 0:G.verified)&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(Z,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",(J=r.profiles)==null?void 0:J.username," · ",new Date(r.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(Q,{text:r.content})})]})]},r.id)}),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:p[e.id]||"",onChange:r=>z({...p,[e.id]:r.target.value}),onFocus:()=>V(e.id),onBlur:()=>V(null),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),B(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>B(e.id),disabled:!((W=p[e.id])!=null&&W.trim()),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${(X=p[e.id])!=null&&X.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(be,{className:"h-5 w-5"})})]})]})]},e.id)})})]}),s.jsx("div",{className:E?"blur-sm pointer-events-none":"",children:s.jsx(fe,{})})]})};export{qe as default};
