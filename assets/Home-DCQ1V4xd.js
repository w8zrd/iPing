import{j as s,s as m,r as c,S as b,u as le,a as ce,b as de,c as ue,l as u}from"./index-BZQ7F-mO.js";import{N as W,M as me}from"./Navigation-BHxv7zvi.js";import{H as G}from"./Header-BlvSSkCw.js";import{P as X}from"./textParser-ByJmUNAd.js";import{X as fe}from"./x-CDV_38W7.js";import{I as ge,S as he}from"./send-C25CpfW9.js";import{C as Y}from"./check-B5qHJ4iQ.js";import{U as xe}from"./user-plus-ZFA2u50O.js";import{c as Z}from"./createLucideIcon-Bmqg_anA.js";import{H as pe}from"./heart--4JWlRtI.js";import{E as we}from"./eye-w-IqLiBy.js";const be=Z("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const ve=Z("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),ye=({text:l="Loading..."})=>s.jsx("div",{className:"flex items-center justify-center",children:s.jsxs("div",{className:"text-center animate-fade-in",children:[s.jsx("div",{className:"inline-block h-12 w-12 animate-spin rounded-full border-4 border-muted border-t-primary"}),s.jsx("p",{className:"mt-4 text-muted-foreground",children:l})]})});async function je(l,a){const{data:{user:n}}=await m.auth.getUser();if(!n)throw new Error("User not authenticated.");if(a){const{error:i}=await m.from("likes").delete().eq("ping_id",l).eq("user_id",n.id);if(i)throw new Error(i.message)}else{const{error:i}=await m.from("likes").insert({ping_id:l,user_id:n.id});if(i)throw new Error(i.message)}}async function Ne({user_id:l,content:a,image_url:n}){const{data:i,error:d}=await m.from("pings").insert({user_id:l,content:a,image_url:n}).select(`
    *,
    profiles(id, username, display_name, verified, is_admin),
    likes(id, user_id),
    comments(id, user_id)
  `);if(d)throw new Error(d.message);return i}async function ke(l){const{data:a,error:n}=await m.from("pings").select(`
      *,
      profiles(id, username, display_name, verified, is_admin),
      likes(id, user_id),
      comments(id, user_id)
    `).eq("id",l).single();if(n)throw new Error(n.message);return a}async function Ee(l){const a=l.name.split(".").pop(),n=`${(await m.auth.getUser()).data.user?.id}/${Date.now()}.${a}`,{data:i,error:d}=await m.storage.from("media").upload(n,l,{cacheControl:"3600",upsert:!1});if(d)throw new Error(`Storage upload failed: ${d.message}`);const{data:x}=m.storage.from("media").getPublicUrl(i.path);return x.publicUrl}class Pe{async getUserId(){const{data:{session:a}}=await m.auth.getSession();return a?.user?.id??null}async fetchOwnProfile(){const a=await this.getUserId();if(!a)return console.error("User not authenticated to fetch profile."),null;const{data:n,error:i}=await m.from("profiles").select("*").eq("id",a).single();return i?(console.error("Error fetching profile:",i.message),null):n}async updateProfile(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to update profile."),null;const i={username:a.username,display_name:a.display_name,bio:a.bio,location:a.location,avatar_url:a.avatar_url},d=Object.fromEntries(Object.entries(i).filter(([,h])=>h!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:x,error:g}=await m.from("profiles").update(d).eq("id",n).select().single();return g?(console.error("Error updating profile:",g.message),null):x}async uploadAvatar(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to upload avatar."),null;a.name.split(".").pop();const i=`avatars/${n}/${Date.now()}_${a.name}`,{error:d}=await m.storage.from("avatars").upload(i,a,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const x=m.storage.from("avatars").getPublicUrl(i).data.publicUrl;return this.updateProfile({avatar_url:x})}async createPost(a,n){const i=await this.getUserId();if(!i)return console.error("User not authenticated to create post."),null;let d;if(n){n.name.split(".").pop();const h=`posts/${i}/${Date.now()}_${n.name}`,{error:p}=await m.storage.from("posts").upload(h,n,{cacheControl:"3600",upsert:!0});if(p)return console.error("Error uploading post image:",p.message),null;d=m.storage.from("posts").getPublicUrl(h).data.publicUrl}const{data:x,error:g}=await m.from("pings").insert({user_id:i,content:a,image_url:d}).select().single();return g?(console.error("Error inserting post:",g.message),null):x}async getPosts(a=20,n=0){try{const{data:i,error:d}=await m.from("pings").select(`
                    *,
                    profiles(id, username, display_name, verified, avatar_url),
                    likes(id, user_id),
                    comments(id)
                `).order("created_at",{ascending:!1}).range(n,n+a-1);return d?(console.error("Error fetching posts:",d.message),null):i}catch(i){return console.error("Exception fetching posts:",i),null}}}const _e=new Pe;function Se({threshold:l=0,root:a=null,rootMargin:n="0%",enabled:i=!0}={}){const[d,x]=c.useState(!1),g=c.useRef(null);return c.useEffect(()=>{if(!i)return;const h=new IntersectionObserver(([H])=>{x(H.isIntersecting)},{threshold:l,root:a,rootMargin:n}),p=g.current;return p&&h.observe(p),()=>{p&&h.unobserve(p)}},[l,a,n,i]),{ref:g,isIntersecting:d}}function Ce(){return s.jsx("div",{className:"w-full max-w-2xl mx-auto space-y-4",children:[1,2,3].map(l=>s.jsxs("div",{className:"glass rounded-3xl p-6 shadow-md",children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx(b,{className:"h-10 w-10 rounded-full"}),s.jsxs("div",{className:"flex-1 space-y-2",children:[s.jsx(b,{className:"h-4 w-1/3"}),s.jsx(b,{className:"h-3 w-1/4"})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(b,{className:"h-4 w-full"}),s.jsx(b,{className:"h-4 w-5/6"})]}),s.jsxs("div",{className:"mt-4 flex gap-4",children:[s.jsx(b,{className:"h-8 w-16 rounded-full"}),s.jsx(b,{className:"h-8 w-16 rounded-full"})]})]},l))})}const Oe=()=>{const l=le();ce();const[a,n]=de(),i=c.useRef({}),[d,x]=c.useState(null),[g,h]=c.useState([]),[p,H]=c.useState([]),[k,F]=c.useState(""),[v,L]=c.useState(!0),[E,J]=c.useState(!1),[y,P]=c.useState(!0),[M,T]=c.useState(0),[_,U]=c.useState(null),[j,O]=c.useState({}),[S,z]=c.useState(null),[N,V]=c.useState(!1),[$,D]=c.useState(null),[I,R]=c.useState(null);c.useEffect(()=>(N?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[N]);const{user:f}=ue(),Q=async e=>{if(!f)return;const{error:t}=await m.from("pings").delete().eq("id",e);t?u.error("Error deleting ping",t,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):h(r=>r.filter(o=>o.id!==e))},q=20,w=c.useCallback(async e=>{if(!y&&e)return;const t=e?M*q:0,r=e?J:L;try{r(!0);const o=await _e.getPosts(q,t);o?(P(o.length===q),T(C=>e?C+1:0),h(C=>{if(e){const oe=new Set(o.map(A=>A.id));return[...C.filter(A=>!oe.has(A.id)),...o]}return o})):P(!1)}catch(o){u.error("Error in loadPosts",o),P(!1)}finally{r(!1)}},[y,M,E]);c.useEffect(()=>{w(!1)},[w]);const{ref:ee,isIntersecting:B}=Se({threshold:.1});if(c.useEffect(()=>{B&&y&&!v&&!E&&w(!0)},[B,y,v,E,w]),c.useEffect(()=>{const e=m.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},async t=>{u.debug("Realtime INSERT received",{new:t.new});try{const r=await ke(t.new.id);h(o=>[r,...o]),T(0),P(!0)}catch(r){u.error("Error fetching new ping details",r)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},t=>{u.debug("Realtime UPDATE received",{new:t.new}),t.new.views!==void 0&&t.new.likes===void 0&&t.new.comments===void 0?h(r=>r.map(o=>o.id===t.new.id?{...o,views:t.new.views}:o)):(u.info("Other ping update, refetching page 0."),w(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},t=>{u.debug("Realtime DELETE received",{oldId:t.old.id}),h(r=>r.filter(o=>o.id!==t.old.id))}).subscribe();return()=>{m.removeChannel(e)}},[w]),c.useEffect(()=>{const e=a.get("ping"),t=a.get("openComments")==="true";e&&(x(e),setTimeout(()=>{const r=i.current[e];r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),t&&U(e))},100))},[a,x,U]),v&&!E&&g.length===0)return s.jsxs("div",{className:"min-h-screen pb-24",children:[s.jsx("div",{className:S?"blur-sm pointer-events-none":"",children:s.jsx(G,{})}),s.jsx("div",{className:"max-w-2xl mx-auto p-4 pt-24",children:s.jsx(Ce,{})}),s.jsx(W,{})]});c.useEffect(()=>{const e=()=>{d&&(x(null),n({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,n]);const se=e=>{const t=e.target.files?.[0];if(t){R(t);const r=new FileReader;r.onloadend=()=>{D(r.result),u.debug("Image loaded for ping preview")},r.readAsDataURL(t)}},re=async()=>{if(!f){l("/auth");return}if(!(!k.trim()&&!I&&!$)){L(!0),u.debug("Home.tsx: Attempting to create new ping",{newPing:k,hasImage:!!I});try{let e;I&&(e=await Ee(I)),await Ne({user_id:f.id,content:k,image_url:e}),u.info("Home.tsx: Ping created successfully."),F(""),D(null),R(null),T(0),P(!0)}catch(e){const t=e instanceof Error?e.message:"An unknown error occurred.";u.error("Home.tsx: Error creating ping",e,{userMessage:`Failed to ping. Please try again. Details: ${t}`,showToast:!0})}finally{L(!1)}}},te=async e=>{if(!f){l("/auth");return}const r=g.find(o=>o.id===e)?.likes?.some(o=>o.user_id===f.id)||!1;try{await je(e,r),u.info(`Home.tsx: Successfully ${r?"unliked":"liked"} ping ${e}.`)}catch(o){const C=o instanceof Error?o.message:"An unknown error occurred.";u.error(`Home.tsx: Error toggling like on ping ${e}`,o,{userMessage:`Failed to change like status. Details: ${C}`,showToast:!0})}w(!1)},K=async e=>{if(!f){l("/auth");return}const t=j[e]?.trim();if(!t)return;u.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:t});const{error:r}=await m.from("comments").insert({user_id:f.id,ping_id:e,content:t});r?u.error("Home.tsx: Error adding comment",r,{userMessage:"Failed to add comment",showToast:!0}):u.info("Home.tsx: Comment added successfully to ping",{pingId:e}),r||(O({...j,[e]:""}),w(!1))},ae=async(e,t)=>{if(!f){l("/auth");return}if(p.includes(e))return;u.debug("Home.tsx: Attempting to send friend request",{from:f.id,to:e});const{error:r}=await m.from("friend_requests").insert({from_user_id:f.id,to_user_id:e});r?u.error("Home.tsx: Error sending friend request",r,{userMessage:"Failed to send friend request."}):u.info("Home.tsx: Friend request sent successfully."),r||H([...p,e])},ne=e=>{U(_===e?null:e)},ie=async e=>{const t=`${window.location.origin}/?ping=${e.id}`,r=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:r,url:t})}catch(o){o.name!=="AbortError"&&(u.error("Home.tsx: Error sharing ping",o,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(t))}else navigator.clipboard.writeText(t)};return s.jsxs("div",{className:"min-h-screen pb-24",children:[s.jsx("div",{className:S||N?"blur-sm pointer-events-none":"",children:s.jsx(G,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${N?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),N&&s.jsx("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-40 animate-fade-in",onClick:()=>V(!1)}),s.jsxs("div",{className:`glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in transition-all duration-300 ${N?"relative z-50 scale-105":""}`,children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:k,onChange:e=>F(e.target.value),onFocus:()=>V(!0),className:"min-h-[100px] rounded-2xl border-2 border-gray-300 resize-none focus:outline-none focus:border-blue-500 transition-all mb-4 p-2 w-full bg-transparent"}),$&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:$,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>{D(null),R(null)},className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(fe,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:se,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple flex items-center justify-center",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(ge,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:re,disabled:v||!k.trim()&&!$,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 text-white font-bold transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:g.map((e,t)=>s.jsxs("div",{ref:r=>i.current[e.id]=r,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${S&&S!==e.id?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${t*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>l(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>l(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(Y,{className:"h-3 w-3 text-white stroke-2"})})]}),f&&e.user_id!==f.id&&s.jsxs("button",{onClick:()=>ae(e.user_id,e.profiles?.display_name||""),disabled:p.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(xe,{className:"h-3 w-3 mr-1"}),p.includes(e.user_id)?"Requested":"Add"]}),e.user_id===f?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>U(_===e.id?null:e.id),children:s.jsx(be,{className:"h-4 w-4"})}),_===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>Q(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(X,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",loading:"lazy",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>te(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(r=>r.user_id===f?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(pe,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(r=>r.user_id===f?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const r=_!==e.id;if(ne(e.id),r){u.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:o}=await m.rpc("increment_ping_views",{_ping_id:e.id});o?u.error("Home.tsx: Error incrementing ping views",o):u.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(me,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>ie(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(ve,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(we,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),_===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(r=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>l(`/profile/${r.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:r.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>l(`/profile/${r.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:r.profiles?.display_name}),r.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(Y,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",r.profiles?.username," · ",new Date(r.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(X,{text:r.content})})]})]},r.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:j[e.id]||"",onChange:r=>O({...j,[e.id]:r.target.value}),onFocus:()=>z(e.id),onBlur:()=>z(null),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),K(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>K(e.id),disabled:!j[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${j[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(he,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:`fixed bottom-0 left-0 right-0 z-50 ${S?"blur-sm pointer-events-none":""}`,children:s.jsx(W,{})}),s.jsxs("div",{ref:ee,className:"h-10 w-full flex items-center justify-center",children:[y&&E&&s.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[s.jsx(ye,{}),"Loading more pings..."]}),!y&&g.length>0&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),g.length===0&&!v&&s.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{Oe as default};
