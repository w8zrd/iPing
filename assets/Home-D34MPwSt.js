import{c as ae,r as o,u as ne,a as ie,b as oe,d as le,l as i,s as b,j as s,L as ce}from"./index-KDRN_gYL.js";import{M as de,N as ue}from"./Navigation-CcC1MPXD.js";import{H as me}from"./Header-BZoDQgUm.js";import{P as X}from"./textParser-BCA8PQrZ.js";import{X as fe}from"./x-DgPzeGSj.js";import{I as ge,S as pe}from"./send-DVRjeo73.js";import{C as Y}from"./check-Bw3-LsES.js";import{U as he}from"./user-plus-CLY9oy6S.js";import{c as q}from"./createLucideIcon-DLprmr0H.js";import{H as xe}from"./heart-CAn7L9--.js";const be=q("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const ve=q("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);const we=q("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),ye="https://ppaibznhkylkhwjqwuuo.supabase.co",je="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwYWliem5oa3lsa2h3anF3dXVvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDUyMjAsImV4cCI6MjA3OTcyMTIyMH0.-rkPk22EDV7Ct2AhGXEVB42u-RZPfdP4wFWv6QC0cMg",v=ae(ye,je);class Ne{async getUserId(){const{data:{session:n}}=await v.auth.getSession();return n?.user?.id??null}async fetchOwnProfile(){const n=await this.getUserId();if(!n)return console.error("User not authenticated to fetch profile."),null;const{data:l,error:c}=await v.from("profiles").select("*").eq("id",n).single();return c?(console.error("Error fetching profile:",c.message),null):l}async updateProfile(n){const l=await this.getUserId();if(!l)return console.error("User not authenticated to update profile."),null;const c={username:n.username,display_name:n.display_name,bio:n.bio,location:n.location,avatar_url:n.avatar_url},d=Object.fromEntries(Object.entries(c).filter(([,f])=>f!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:h,error:m}=await v.from("profiles").update(d).eq("id",l).select().single();return m?(console.error("Error updating profile:",m.message),null):h}async uploadAvatar(n){const l=await this.getUserId();if(!l)return console.error("User not authenticated to upload avatar."),null;n.name.split(".").pop();const c=`avatars/${l}/${Date.now()}_${n.name}`,{error:d}=await v.storage.from("avatars").upload(c,n,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const h=v.storage.from("avatars").getPublicUrl(c).data.publicUrl;return this.updateProfile({avatar_url:h})}async createPost(n,l){const c=await this.getUserId();if(!c)return console.error("User not authenticated to create post."),null;let d;if(l){l.name.split(".").pop();const f=`posts/${c}/${Date.now()}_${l.name}`,{error:p}=await v.storage.from("posts").upload(f,l,{cacheControl:"3600",upsert:!0});if(p)return console.error("Error uploading post image:",p.message),null;d=v.storage.from("posts").getPublicUrl(f).data.publicUrl}const{data:h,error:m}=await v.from("posts").insert({user_id:c,content:n,image_url:d}).select().single();return m?(console.error("Error inserting post:",m.message),null):h}async getPosts(n=20,l=0){const{data:c,error:d}=await v.from("posts").select("*").order("created_at",{ascending:!1}).range(l,l+n-1);return d?(console.error("Error fetching posts:",d.message),null):c}}const ke=new Ne;function Ee({threshold:g=0,root:n=null,rootMargin:l="0%",enabled:c=!0}={}){const[d,h]=o.useState(!1),m=o.useRef(null);return o.useEffect(()=>{if(!c)return;const f=new IntersectionObserver(([A])=>{h(A.isIntersecting)},{threshold:g,root:n,rootMargin:l}),p=m.current;return p&&f.observe(p),()=>{p&&f.unobserve(p)}},[g,n,l,c]),{ref:m,isIntersecting:d}}const $e=()=>{const g=ne();ie();const[n,l]=oe(),c=o.useRef({}),[d,h]=o.useState(null),[m,f]=o.useState([]),[p,A]=o.useState([]),[E,F]=o.useState(""),[w,_]=o.useState(!0),[C,Z]=o.useState(!1),[y,S]=o.useState(!0),[I,L]=o.useState(0),[P,U]=o.useState(null),[j,O]=o.useState({}),[H,B]=o.useState(null),[R,V]=o.useState(!1),[N,T]=o.useState(null),{user:u}=le(),G=async e=>{if(!u)return;const{error:r}=await b.from("pings").delete().eq("id",e);r?i.error("Error deleting ping",r,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):f(t=>t.filter(a=>a.id!==e))},$=20,x=o.useCallback(async e=>{if(!y&&e)return;const r=e?I*$:0,t=e?Z:_;t(!0);const a=await ke.getPosts($,r);a?(S(a.length===$),L(k=>e?k+1:0),f(k=>{if(e){const M=new Set(a.map(D=>D.id));return[...k.filter(D=>!M.has(D.id)),...a]}return a})):(S(!1),i.error("Error fetching posts",{userMessage:"Failed to fetch pings. Please try again."})),t(!1)},[y,I,C]);o.useEffect(()=>{x(!1)},[x]);const{ref:K,isIntersecting:z}=Ee({threshold:.1});o.useEffect(()=>{z&&y&&!w&&!C&&x(!0)},[z,y,w,C,x]),o.useEffect(()=>{I===0&&m.length>0&&w&&_(!1)},[m,w,I]),o.useEffect(()=>{const e=b.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},r=>{i.debug("Realtime INSERT received",{new:r.new}),f(t=>[r.new,...t]),L(0),S(!0)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},r=>{i.debug("Realtime UPDATE received",{new:r.new}),r.new.views!==void 0?f(t=>t.map(a=>a.id===r.new.id?{...a,views:r.new.views}:a)):(i.info("Other ping update, refetching page 0."),x(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},r=>{i.debug("Realtime DELETE received",{oldId:r.old.id}),f(t=>t.filter(a=>a.id!==r.old.id)),x(!1)}).subscribe();return()=>{b.removeChannel(e)}},[x]),o.useEffect(()=>{const e=n.get("ping"),r=n.get("openComments")==="true";e&&(h(e),setTimeout(()=>{const t=c.current[e];t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),r&&U(e))},100))},[n,h,U]),o.useEffect(()=>{const e=()=>{d&&(h(null),l({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,l]);const Q=e=>{const r=e.target.files?.[0];if(r){const t=new FileReader;t.onloadend=()=>{T(t.result),i.debug("Image loaded for ping preview")},t.readAsDataURL(r)}},W=async()=>{if(!u){g("/auth");return}if(!(!E.trim()&&!N)){_(!0),i.debug("Home.tsx: Attempting to create new ping",{newPing:E,pingImage:N});try{const{error:e}=await b.from("pings").insert({user_id:u.id,content:E,image_url:N||void 0});e?i.error("Home.tsx: Error creating ping",e,{userMessage:"Failed to ping. Please try again.",showToast:!0}):(i.info("Home.tsx: Ping created successfully."),F(""),T(null),L(0),S(!0),x(!1))}catch(e){i.error("Home.tsx: Unexpected error creating ping",e,{userMessage:"An unexpected error occurred while creating ping.",showToast:!0})}finally{_(!1)}}},ee=async e=>{if(!u){g("/auth");return}const r=m.find(a=>a.id===e);if(r?.likes?.some(a=>a.user_id===u.id)){i.debug("Home.tsx: User unliking ping",{pingId:e});const a=r?.likes?.find(M=>M.user_id===u.id)?.id,{error:k}=await b.from("likes").delete().eq("id",a);k&&i.error("Home.tsx: Error unliking ping",k)}else{i.debug("Home.tsx: User liking ping",{pingId:e});const{error:a}=await b.from("likes").insert({user_id:u.id,post_id:e});a&&i.error("Home.tsx: Error liking ping",a)}x(!1)},J=async e=>{if(!u){g("/auth");return}const r=j[e]?.trim();if(!r)return;i.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:r});const{error:t}=await b.from("comments").insert({user_id:u.id,ping_id:e,content:r});t?i.error("Home.tsx: Error adding comment",t,{userMessage:"Failed to add comment",showToast:!0}):i.info("Home.tsx: Comment added successfully to ping",{pingId:e}),t||(O({...j,[e]:""}),x(!1))},se=async(e,r)=>{if(!u){g("/auth");return}if(p.includes(e))return;i.debug("Home.tsx: Attempting to send friend request",{from:u.id,to:e});const{error:t}=await b.from("friend_requests").insert({from_user_id:u.id,to_user_id:e});t?i.error("Home.tsx: Error sending friend request",t,{userMessage:"Failed to send friend request."}):i.info("Home.tsx: Friend request sent successfully."),t||A([...p,e])},te=e=>{U(P===e?null:e)},re=async e=>{const r=`${window.location.origin}/?ping=${e.id}`,t=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:t,url:r})}catch(a){a.name!=="AbortError"&&(i.error("Home.tsx: Error sharing ping",a,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(r))}else navigator.clipboard.writeText(r)};return s.jsxs("div",{className:"min-h-screen pb-32",children:[s.jsx("div",{className:H||R?"blur-sm pointer-events-none":"",children:s.jsx(me,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${R?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:E,onChange:e=>F(e.target.value),onFocus:()=>V(!0),onBlur:()=>V(!1),className:"min-h-[100px] rounded-2xl border-border/50 resize-none focus-visible:ring-0 focus-visible:ring-offset-0 focus-visible:border-primary transition-apple mb-4 p-2 w-full bg-transparent"}),N&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:N,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>T(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(fe,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:Q,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(ge,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:W,disabled:w||!E.trim()&&!N,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 font-semibold transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:m.map((e,r)=>s.jsxs("div",{ref:t=>c.current[e.id]=t,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${H&&H!==e.id||R?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${r*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>g(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>g(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(Y,{className:"h-3 w-3 text-white stroke-2"})})]}),u&&e.user_id!==u.id&&s.jsxs("button",{onClick:()=>se(e.user_id,e.profiles?.display_name||""),disabled:p.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(he,{className:"h-3 w-3 mr-1"}),p.includes(e.user_id)?"Requested":"Add"]}),e.user_id===u?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>U(P===e.id?null:e.id),children:s.jsx(be,{className:"h-4 w-4"})}),P===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>G(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(X,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>ee(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(t=>t.user_id===u?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(xe,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(t=>t.user_id===u?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const t=P!==e.id;if(te(e.id),t){i.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:a}=await b.rpc("increment_ping_views",{_ping_id:e.id});a?i.error("Home.tsx: Error incrementing ping views",a):i.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(de,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>re(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(we,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(ve,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),P===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(t=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>g(`/profile/${t.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:t.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>g(`/profile/${t.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:t.profiles?.display_name}),t.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(Y,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",t.profiles?.username," · ",new Date(t.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(X,{text:t.content})})]})]},t.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:j[e.id]||"",onChange:t=>O({...j,[e.id]:t.target.value}),onFocus:()=>B(e.id),onBlur:()=>B(null),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),J(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>J(e.id),disabled:!j[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${j[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(pe,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:H?"blur-sm pointer-events-none":"",children:s.jsx(ue,{})}),s.jsxs("div",{ref:K,className:"h-10 w-full flex items-center justify-center",children:[y&&C&&s.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[s.jsx(ce,{}),"Loading more pings..."]}),!y&&m.length>0&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),m.length===0&&!w&&s.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{$e as default};
