import{e as _,u as S,r,g as E,d as I,s as n,j as e}from"./index-KDRN_gYL.js";import{A,a as R}from"./Avatar-D479fCOz.js";import{B as h}from"./Button-DXx1TdXG.js";import{T}from"./Textarea-BkhExQ7r.js";import{P as q}from"./textParser-BCA8PQrZ.js";import{A as z}from"./arrow-left-BPQiwUrU.js";import{C as j}from"./check-Bw3-LsES.js";import{c as D}from"./createLucideIcon-DLprmr0H.js";import{X as L}from"./x-DgPzeGSj.js";import{I as U,S as M}from"./send-DVRjeo73.js";import"./utils-Dtjc6EhN.js";const N=D("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]),Q=()=>{const{chatId:a}=_(),v=S(),[l,x]=r.useState(""),[u,b]=r.useState([]),[i,y]=r.useState(null),[f,o]=r.useState(null),{markChatAsRead:w}=E(),{user:t}=I(),p=r.useRef(null);r.useEffect(()=>{a&&t&&(w(a),k(),d())},[a,t]),r.useEffect(()=>{if(!a)return;const s=n.channel(`messages-${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`chat_id=eq.${a}`},()=>{d()}).subscribe();return()=>{n.removeChannel(s)}},[a]),r.useEffect(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[u]);const k=async()=>{if(!a||!t)return;const{data:s}=await n.from("chat_participants").select("user_id, profiles!chat_participants_user_id_fkey(id, username, display_name, verified)").eq("chat_id",a).neq("user_id",t.id).single();s?.profiles&&y(s.profiles)},d=async()=>{if(!a)return;const{data:s,error:c}=await n.from("messages").select("*").eq("chat_id",a).order("created_at",{ascending:!0});!c&&s&&b(s)},C=s=>{const c=s.target.files?.[0];if(c){const m=new FileReader;m.onloadend=()=>{o(m.result)},m.readAsDataURL(c)}},g=async()=>{if(!l.trim()||!a||!t)return;const{error:s}=await n.from("messages").insert({chat_id:a,user_id:t.id,content:l,status:"sent"});s||(x(""),o(null),d())};return i?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx("header",{className:"fixed top-0 left-0 right-0 z-50 glass-strong border-b",children:e.jsxs("div",{className:"flex items-center gap-3 p-4",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>v("/chats"),className:"rounded-full",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx(A,{className:"w-10 h-10",children:e.jsx(R,{className:"bg-gradient-to-br from-primary via-primary/80 to-primary/50 text-white font-bold",children:i.display_name[0]?.toUpperCase()})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-semibold",children:i.display_name}),i.verified&&e.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:e.jsx(j,{className:"h-3 w-3 text-white stroke-[3]"})})]}),e.jsx("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:e.jsxs("span",{children:["@",i.username]})})]})]})]})}),e.jsx("main",{className:"flex-1 pt-20 pb-32 px-4 max-w-2xl mx-auto w-full",children:e.jsxs("div",{className:"space-y-4",children:[u.map(s=>e.jsx("div",{className:`flex ${s.user_id===t?.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-2xl px-4 py-2 ${s.user_id===t?.id?"bg-primary text-primary-foreground":"glass-strong"}`,children:[e.jsx("p",{className:"text-sm",children:e.jsx(q,{text:s.content})}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx("p",{className:"text-xs opacity-70",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s.user_id===t?.id&&s.status&&e.jsxs("span",{children:[s.status==="sent"&&e.jsx(j,{className:"h-3 w-3"}),s.status==="delivered"&&e.jsx(N,{className:"h-3 w-3"}),s.status==="seen"&&e.jsx(N,{className:"h-3 w-3 text-green-400"})]})]})]})},s.id)),e.jsx("div",{ref:p})]})}),e.jsx("footer",{className:"fixed bottom-0 left-0 right-0 z-50 pb-safe",children:e.jsxs("div",{className:"glass-strong border-t mx-4 mb-4 rounded-3xl p-4",children:[f&&e.jsxs("div",{className:"relative mb-3",children:[e.jsx("img",{src:f,alt:"Upload preview",className:"rounded-2xl max-h-40 w-auto"}),e.jsx("button",{onClick:()=>o(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:e.jsx(L,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("label",{className:"shrink-0",children:[e.jsx("input",{type:"file",accept:"image/*",onChange:C,className:"hidden"}),e.jsx(h,{type:"button",variant:"outline",size:"icon",className:"rounded-full h-11 w-11",onClick:s=>{s.preventDefault(),s.currentTarget.previousElementSibling?.click()},children:e.jsx(U,{className:"h-5 w-5"})})]}),e.jsx(T,{value:l,onChange:s=>x(s.target.value),placeholder:"Type a message...",className:"flex-1 min-h-[44px] max-h-32 resize-none rounded-2xl",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),g())}}),e.jsx(h,{onClick:g,size:"icon",className:"rounded-full h-11 w-11 shrink-0",disabled:!l.trim(),children:e.jsx(M,{className:"h-5 w-5"})})]})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:"Loading..."})};export{Q as default};
