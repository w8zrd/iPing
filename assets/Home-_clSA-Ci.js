import{j as s,s as m,r as c,u as te,a as ae,b as ne,c as ie,l as u}from"./index-CmjTYx1p.js";import{M as oe,N as le}from"./Navigation-CHjydaJ2.js";import{H as ce}from"./Header-YnqcYYPA.js";import{P as V}from"./textParser-D5nydWJE.js";import{X as de}from"./x-p25QsYo7.js";import{I as ue,S as me}from"./send-Cavghul3.js";import{C as B}from"./check-B4vFeBbu.js";import{U as fe}from"./user-plus-1hQefAXV.js";import{c as K}from"./createLucideIcon-CKR8FJiQ.js";import{H as ge}from"./heart-BeN3r4xt.js";import{E as he}from"./eye-UN1oel31.js";const pe=K("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const xe=K("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),be=({text:l="Loading..."})=>s.jsx("div",{className:"flex items-center justify-center",children:s.jsxs("div",{className:"text-center animate-fade-in",children:[s.jsx("div",{className:"inline-block h-12 w-12 animate-spin rounded-full border-4 border-muted border-t-primary"}),s.jsx("p",{className:"mt-4 text-muted-foreground",children:l})]})});async function we(l,a){const{data:{user:n}}=await m.auth.getUser();if(!n)throw new Error("User not authenticated.");if(a){const{error:i}=await m.from("likes").delete().eq("ping_id",l).eq("user_id",n.id);if(i)throw new Error(i.message)}else{const{error:i}=await m.from("likes").insert({ping_id:l,user_id:n.id});if(i)throw new Error(i.message)}}async function ve({user_id:l,content:a,image_url:n}){const{data:i,error:d}=await m.from("pings").insert({user_id:l,content:a,image_url:n}).select(`
    *,
    profiles(id, username, display_name, verified, is_admin),
    likes(id, user_id),
    comments(id, user_id)
  `);if(d)throw new Error(d.message);return i}async function ye(l){const{data:a,error:n}=await m.from("pings").select(`
      *,
      profiles(id, username, display_name, verified, is_admin),
      likes(id, user_id),
      comments(id, user_id)
    `).eq("id",l).single();if(n)throw new Error(n.message);return a}async function je(l){const a=l.name.split(".").pop(),n=`${(await m.auth.getUser()).data.user?.id}/${Date.now()}.${a}`,{data:i,error:d}=await m.storage.from("media").upload(n,l,{cacheControl:"3600",upsert:!1});if(d)throw new Error(`Storage upload failed: ${d.message}`);const{data:p}=m.storage.from("media").getPublicUrl(i.path);return p.publicUrl}class Ne{async getUserId(){const{data:{session:a}}=await m.auth.getSession();return a?.user?.id??null}async fetchOwnProfile(){const a=await this.getUserId();if(!a)return console.error("User not authenticated to fetch profile."),null;const{data:n,error:i}=await m.from("profiles").select("*").eq("id",a).single();return i?(console.error("Error fetching profile:",i.message),null):n}async updateProfile(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to update profile."),null;const i={username:a.username,display_name:a.display_name,bio:a.bio,location:a.location,avatar_url:a.avatar_url},d=Object.fromEntries(Object.entries(i).filter(([,h])=>h!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:p,error:f}=await m.from("profiles").update(d).eq("id",n).select().single();return f?(console.error("Error updating profile:",f.message),null):p}async uploadAvatar(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to upload avatar."),null;a.name.split(".").pop();const i=`avatars/${n}/${Date.now()}_${a.name}`,{error:d}=await m.storage.from("avatars").upload(i,a,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const p=m.storage.from("avatars").getPublicUrl(i).data.publicUrl;return this.updateProfile({avatar_url:p})}async createPost(a,n){const i=await this.getUserId();if(!i)return console.error("User not authenticated to create post."),null;let d;if(n){n.name.split(".").pop();const h=`posts/${i}/${Date.now()}_${n.name}`,{error:x}=await m.storage.from("posts").upload(h,n,{cacheControl:"3600",upsert:!0});if(x)return console.error("Error uploading post image:",x.message),null;d=m.storage.from("posts").getPublicUrl(h).data.publicUrl}const{data:p,error:f}=await m.from("posts").insert({user_id:i,content:a,image_url:d}).select().single();return f?(console.error("Error inserting post:",f.message),null):p}async getPosts(a=20,n=0){const{data:i,error:d}=await m.from("posts").select("*").order("created_at",{ascending:!1}).range(n,n+a-1);return d?(console.error("Error fetching posts:",d.message),null):i}}const ke=new Ne;function Ee({threshold:l=0,root:a=null,rootMargin:n="0%",enabled:i=!0}={}){const[d,p]=c.useState(!1),f=c.useRef(null);return c.useEffect(()=>{if(!i)return;const h=new IntersectionObserver(([I])=>{p(I.isIntersecting)},{threshold:l,root:a,rootMargin:n}),x=f.current;return x&&h.observe(x),()=>{x&&h.unobserve(x)}},[l,a,n,i]),{ref:f,isIntersecting:d}}const qe=()=>{const l=te();ae();const[a,n]=ne(),i=c.useRef({}),[d,p]=c.useState(null),[f,h]=c.useState([]),[x,I]=c.useState([]),[j,A]=c.useState(""),[w,E]=c.useState(!0),[P,W]=c.useState(!1),[v,_]=c.useState(!0),[C,L]=c.useState(0),[N,S]=c.useState(null),[y,M]=c.useState({}),[U,F]=c.useState(null),[$,T]=c.useState(null),[H,D]=c.useState(null),{user:g}=ie(),G=async e=>{if(!g)return;const{error:t}=await m.from("pings").delete().eq("id",e);t?u.error("Error deleting ping",t,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):h(r=>r.filter(o=>o.id!==e))},R=20,b=c.useCallback(async e=>{if(!v&&e)return;const t=e?C*R:0,r=e?W:E;r(!0);const o=await ke.getPosts(R,t);o?(_(o.length===R),L(k=>e?k+1:0),h(k=>{if(e){const re=new Set(o.map(q=>q.id));return[...k.filter(q=>!re.has(q.id)),...o]}return o})):(_(!1),u.error("Error fetching posts",{userMessage:"Failed to fetch pings. Please try again."})),r(!1)},[v,C,P]);c.useEffect(()=>{b(!1)},[b]);const{ref:X,isIntersecting:O}=Ee({threshold:.1});c.useEffect(()=>{O&&v&&!w&&!P&&b(!0)},[O,v,w,P,b]),c.useEffect(()=>{C===0&&f.length>0&&w&&E(!1)},[f,w,C]),c.useEffect(()=>{const e=m.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},async t=>{u.debug("Realtime INSERT received",{new:t.new});try{const r=await ye(t.new.id);h(o=>[r,...o]),L(0),_(!0)}catch(r){u.error("Error fetching new ping details",r)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},t=>{u.debug("Realtime UPDATE received",{new:t.new}),t.new.views!==void 0&&t.new.likes===void 0&&t.new.comments===void 0?h(r=>r.map(o=>o.id===t.new.id?{...o,views:t.new.views}:o)):(u.info("Other ping update, refetching page 0."),b(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},t=>{u.debug("Realtime DELETE received",{oldId:t.old.id}),h(r=>r.filter(o=>o.id!==t.old.id))}).subscribe();return()=>{m.removeChannel(e)}},[b]),c.useEffect(()=>{const e=a.get("ping"),t=a.get("openComments")==="true";e&&(p(e),setTimeout(()=>{const r=i.current[e];r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),t&&S(e))},100))},[a,p,S]),c.useEffect(()=>{const e=()=>{d&&(p(null),n({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,n]);const Y=e=>{const t=e.target.files?.[0];if(t){D(t);const r=new FileReader;r.onloadend=()=>{T(r.result),u.debug("Image loaded for ping preview")},r.readAsDataURL(t)}},Z=async()=>{if(!g){l("/auth");return}if(!(!j.trim()&&!H&&!$)){E(!0),u.debug("Home.tsx: Attempting to create new ping",{newPing:j,hasImage:!!H});try{let e;H&&(e=await je(H)),await ve({user_id:g.id,content:j,image_url:e}),u.info("Home.tsx: Ping created successfully."),A(""),T(null),D(null),L(0),_(!0)}catch(e){const t=e instanceof Error?e.message:"An unknown error occurred.";u.error("Home.tsx: Error creating ping",e,{userMessage:`Failed to ping. Please try again. Details: ${t}`,showToast:!0})}finally{E(!1)}}},J=async e=>{if(!g){l("/auth");return}const r=f.find(o=>o.id===e)?.likes?.some(o=>o.user_id===g.id)||!1;try{await we(e,r),u.info(`Home.tsx: Successfully ${r?"unliked":"liked"} ping ${e}.`)}catch(o){const k=o instanceof Error?o.message:"An unknown error occurred.";u.error(`Home.tsx: Error toggling like on ping ${e}`,o,{userMessage:`Failed to change like status. Details: ${k}`,showToast:!0})}b(!1)},z=async e=>{if(!g){l("/auth");return}const t=y[e]?.trim();if(!t)return;u.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:t});const{error:r}=await m.from("comments").insert({user_id:g.id,ping_id:e,content:t});r?u.error("Home.tsx: Error adding comment",r,{userMessage:"Failed to add comment",showToast:!0}):u.info("Home.tsx: Comment added successfully to ping",{pingId:e}),r||(M({...y,[e]:""}),b(!1))},Q=async(e,t)=>{if(!g){l("/auth");return}if(x.includes(e))return;u.debug("Home.tsx: Attempting to send friend request",{from:g.id,to:e});const{error:r}=await m.from("friend_requests").insert({from_user_id:g.id,to_user_id:e});r?u.error("Home.tsx: Error sending friend request",r,{userMessage:"Failed to send friend request."}):u.info("Home.tsx: Friend request sent successfully."),r||I([...x,e])},ee=e=>{S(N===e?null:e)},se=async e=>{const t=`${window.location.origin}/?ping=${e.id}`,r=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:r,url:t})}catch(o){o.name!=="AbortError"&&(u.error("Home.tsx: Error sharing ping",o,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(t))}else navigator.clipboard.writeText(t)};return s.jsxs("div",{className:"min-h-screen pb-24",children:[s.jsx("div",{className:U?"blur-sm pointer-events-none":"",children:s.jsx(ce,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:"mb-8 pt-24 animate-fade-in",children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:j,onChange:e=>A(e.target.value),className:"min-h-[100px] rounded-2xl border-2 border-border/50 resize-none focus:outline-none focus:border-primary transition-all mb-4 p-2 w-full bg-transparent"}),$&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:$,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>{T(null),D(null)},className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(de,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:Y,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple flex items-center justify-center",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(ue,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:Z,disabled:w||!j.trim()&&!$,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 text-white font-bold transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:f.map((e,t)=>s.jsxs("div",{ref:r=>i.current[e.id]=r,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${U&&U!==e.id?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${t*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>l(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>l(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(B,{className:"h-3 w-3 text-white stroke-2"})})]}),g&&e.user_id!==g.id&&s.jsxs("button",{onClick:()=>Q(e.user_id,e.profiles?.display_name||""),disabled:x.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(fe,{className:"h-3 w-3 mr-1"}),x.includes(e.user_id)?"Requested":"Add"]}),e.user_id===g?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>S(N===e.id?null:e.id),children:s.jsx(pe,{className:"h-4 w-4"})}),N===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>G(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(V,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",loading:"lazy",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>J(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(r=>r.user_id===g?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(ge,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(r=>r.user_id===g?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const r=N!==e.id;if(ee(e.id),r){u.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:o}=await m.rpc("increment_ping_views",{_ping_id:e.id});o?u.error("Home.tsx: Error incrementing ping views",o):u.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(oe,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>se(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(xe,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(he,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),N===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(r=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>l(`/profile/${r.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:r.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>l(`/profile/${r.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:r.profiles?.display_name}),r.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(B,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",r.profiles?.username," · ",new Date(r.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(V,{text:r.content})})]})]},r.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:y[e.id]||"",onChange:r=>M({...y,[e.id]:r.target.value}),onFocus:()=>F(e.id),onBlur:()=>F(null),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),z(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>z(e.id),disabled:!y[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${y[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(me,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:`fixed bottom-0 left-0 right-0 z-50 ${U?"blur-sm pointer-events-none":""}`,children:s.jsx(le,{})}),s.jsxs("div",{ref:X,className:"h-10 w-full flex items-center justify-center",children:[v&&P&&s.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[s.jsx(be,{}),"Loading more pings..."]}),!v&&f.length>0&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),f.length===0&&!w&&s.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{qe as default};
