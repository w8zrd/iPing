import{s as u,r as l,u as te,a as ae,b as ne,c as ie,l as c,j as s,L as oe}from"./index-BUptPd_Y.js";import{M as le,N as ce}from"./Navigation-BDmsH8E-.js";import{H as de}from"./Header-BYNrzkXF.js";import{P as B}from"./textParser-YC_Z5IWg.js";import{X as ue}from"./x-DliDnnbU.js";import{I as me,S as fe}from"./send-W5reZghJ.js";import{C as V}from"./check-YHKVmuRE.js";import{U as ge}from"./user-plus-Dp18OBwB.js";import{c as K}from"./createLucideIcon-XbBiZBHU.js";import{H as he}from"./heart-BnQgaLhW.js";import{E as pe}from"./eye-Bos-6ldb.js";const xe=K("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const be=K("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);class we{async getUserId(){const{data:{session:a}}=await u.auth.getSession();return a?.user?.id??null}async fetchOwnProfile(){const a=await this.getUserId();if(!a)return console.error("User not authenticated to fetch profile."),null;const{data:n,error:o}=await u.from("profiles").select("*").eq("id",a).single();return o?(console.error("Error fetching profile:",o.message),null):n}async updateProfile(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to update profile."),null;const o={username:a.username,display_name:a.display_name,bio:a.bio,location:a.location,avatar_url:a.avatar_url},d=Object.fromEntries(Object.entries(o).filter(([,h])=>h!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:x,error:f}=await u.from("profiles").update(d).eq("id",n).select().single();return f?(console.error("Error updating profile:",f.message),null):x}async uploadAvatar(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to upload avatar."),null;a.name.split(".").pop();const o=`avatars/${n}/${Date.now()}_${a.name}`,{error:d}=await u.storage.from("avatars").upload(o,a,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const x=u.storage.from("avatars").getPublicUrl(o).data.publicUrl;return this.updateProfile({avatar_url:x})}async createPost(a,n){const o=await this.getUserId();if(!o)return console.error("User not authenticated to create post."),null;let d;if(n){n.name.split(".").pop();const h=`posts/${o}/${Date.now()}_${n.name}`,{error:p}=await u.storage.from("posts").upload(h,n,{cacheControl:"3600",upsert:!0});if(p)return console.error("Error uploading post image:",p.message),null;d=u.storage.from("posts").getPublicUrl(h).data.publicUrl}const{data:x,error:f}=await u.from("posts").insert({user_id:o,content:a,image_url:d}).select().single();return f?(console.error("Error inserting post:",f.message),null):x}async getPosts(a=20,n=0){const{data:o,error:d}=await u.from("posts").select("*").order("created_at",{ascending:!1}).range(n,n+a-1);return d?(console.error("Error fetching posts:",d.message),null):o}}const ve=new we;async function ye(m,a){const{data:{user:n}}=await u.auth.getUser();if(!n)throw new Error("User not authenticated.");if(a){const{error:o}=await u.from("likes").delete().eq("ping_id",m).eq("user_id",n.id);if(o)throw new Error(o.message)}else{const{error:o}=await u.from("likes").insert({ping_id:m,user_id:n.id});if(o)throw new Error(o.message)}}async function je({user_id:m,content:a,image_url:n}){const{data:o,error:d}=await u.from("pings").insert({user_id:m,content:a,image_url:n}).select(`
    *,
    profiles(id, username, display_name, verified, is_admin),
    likes(id, user_id),
    comments(id, user_id)
  `);if(d)throw new Error(d.message);return o}async function Ne(m){const{data:a,error:n}=await u.from("pings").select(`
      *,
      profiles(id, username, display_name, verified, is_admin),
      likes(id, user_id),
      comments(id, user_id)
    `).eq("id",m).single();if(n)throw new Error(n.message);return a}function ke({threshold:m=0,root:a=null,rootMargin:n="0%",enabled:o=!0}={}){const[d,x]=l.useState(!1),f=l.useRef(null);return l.useEffect(()=>{if(!o)return;const h=new IntersectionObserver(([I])=>{x(I.isIntersecting)},{threshold:m,root:a,rootMargin:n}),p=f.current;return p&&h.observe(p),()=>{p&&h.unobserve(p)}},[m,a,n,o]),{ref:f,isIntersecting:d}}const qe=()=>{const m=te();ae();const[a,n]=ne(),o=l.useRef({}),[d,x]=l.useState(null),[f,h]=l.useState([]),[p,I]=l.useState([]),[N,A]=l.useState(""),[w,P]=l.useState(!0),[_,W]=l.useState(!1),[v,C]=l.useState(!0),[S,H]=l.useState(0),[k,U]=l.useState(null),[y,D]=l.useState({}),[$,M]=l.useState(null),[L,F]=l.useState(!1),[j,T]=l.useState(null),{user:g}=ie(),G=async e=>{if(!g)return;const{error:t}=await u.from("pings").delete().eq("id",e);t?c.error("Error deleting ping",t,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):h(r=>r.filter(i=>i.id!==e))},R=20,b=l.useCallback(async e=>{if(!v&&e)return;const t=e?S*R:0,r=e?W:P;r(!0);const i=await ve.getPosts(R,t);i?(C(i.length===R),H(E=>e?E+1:0),h(E=>{if(e){const re=new Set(i.map(q=>q.id));return[...E.filter(q=>!re.has(q.id)),...i]}return i})):(C(!1),c.error("Error fetching posts",{userMessage:"Failed to fetch pings. Please try again."})),r(!1)},[v,S,_]);l.useEffect(()=>{b(!1)},[b]);const{ref:X,isIntersecting:O}=ke({threshold:.1});l.useEffect(()=>{O&&v&&!w&&!_&&b(!0)},[O,v,w,_,b]),l.useEffect(()=>{S===0&&f.length>0&&w&&P(!1)},[f,w,S]),l.useEffect(()=>{const e=u.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},async t=>{c.debug("Realtime INSERT received",{new:t.new});try{const r=await Ne(t.new.id);h(i=>[r,...i]),H(0),C(!0)}catch(r){c.error("Error fetching new ping details",r)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},t=>{c.debug("Realtime UPDATE received",{new:t.new}),t.new.views!==void 0&&t.new.likes===void 0&&t.new.comments===void 0?h(r=>r.map(i=>i.id===t.new.id?{...i,views:t.new.views}:i)):(c.info("Other ping update, refetching page 0."),b(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},t=>{c.debug("Realtime DELETE received",{oldId:t.old.id}),h(r=>r.filter(i=>i.id!==t.old.id))}).subscribe();return()=>{u.removeChannel(e)}},[b]),l.useEffect(()=>{const e=a.get("ping"),t=a.get("openComments")==="true";e&&(x(e),setTimeout(()=>{const r=o.current[e];r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),t&&U(e))},100))},[a,x,U]),l.useEffect(()=>{const e=()=>{d&&(x(null),n({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,n]);const Y=e=>{const t=e.target.files?.[0];if(t){const r=new FileReader;r.onloadend=()=>{T(r.result),c.debug("Image loaded for ping preview")},r.readAsDataURL(t)}},Z=async()=>{if(!g){m("/auth");return}if(!(!N.trim()&&!j)){P(!0),c.debug("Home.tsx: Attempting to create new ping",{newPing:N,pingImage:j});try{await je({user_id:g.id,content:N,image_url:j||void 0}),c.info("Home.tsx: Ping created successfully."),A(""),T(null),H(0),C(!0)}catch(e){const t=e instanceof Error?e.message:"An unknown error occurred.";c.error("Home.tsx: Error creating ping",e,{userMessage:`Failed to ping. Please try again. Details: ${t}`,showToast:!0})}finally{P(!1)}}},J=async e=>{if(!g){m("/auth");return}const r=f.find(i=>i.id===e)?.likes?.some(i=>i.user_id===g.id)||!1;try{await ye(e,r),c.info(`Home.tsx: Successfully ${r?"unliked":"liked"} ping ${e}.`)}catch(i){const E=i instanceof Error?i.message:"An unknown error occurred.";c.error(`Home.tsx: Error toggling like on ping ${e}`,i,{userMessage:`Failed to change like status. Details: ${E}`,showToast:!0})}b(!1)},z=async e=>{if(!g){m("/auth");return}const t=y[e]?.trim();if(!t)return;c.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:t});const{error:r}=await u.from("comments").insert({user_id:g.id,ping_id:e,content:t});r?c.error("Home.tsx: Error adding comment",r,{userMessage:"Failed to add comment",showToast:!0}):c.info("Home.tsx: Comment added successfully to ping",{pingId:e}),r||(D({...y,[e]:""}),b(!1))},Q=async(e,t)=>{if(!g){m("/auth");return}if(p.includes(e))return;c.debug("Home.tsx: Attempting to send friend request",{from:g.id,to:e});const{error:r}=await u.from("friend_requests").insert({from_user_id:g.id,to_user_id:e});r?c.error("Home.tsx: Error sending friend request",r,{userMessage:"Failed to send friend request."}):c.info("Home.tsx: Friend request sent successfully."),r||I([...p,e])},ee=e=>{U(k===e?null:e)},se=async e=>{const t=`${window.location.origin}/?ping=${e.id}`,r=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:r,url:t})}catch(i){i.name!=="AbortError"&&(c.error("Home.tsx: Error sharing ping",i,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(t))}else navigator.clipboard.writeText(t)};return s.jsxs("div",{className:"min-h-screen pb-32",children:[s.jsx("div",{className:$||L?"blur-sm pointer-events-none":"",children:s.jsx(de,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${L?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:N,onChange:e=>A(e.target.value),onFocus:()=>F(!0),onBlur:()=>F(!1),className:"min-h-[100px] rounded-2xl border border-border/50 resize-none focus:ring-2 focus:ring-primary focus:border-primary transition-apple mb-4 p-2 w-full bg-transparent"}),j&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:j,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>T(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(ue,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:Y,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple flex items-center justify-center",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(me,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:Z,disabled:w||!N.trim()&&!j,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 text-white font-bold transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:f.map((e,t)=>s.jsxs("div",{ref:r=>o.current[e.id]=r,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${$&&$!==e.id||L?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${t*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>m(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>m(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(V,{className:"h-3 w-3 text-white stroke-2"})})]}),g&&e.user_id!==g.id&&s.jsxs("button",{onClick:()=>Q(e.user_id,e.profiles?.display_name||""),disabled:p.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(ge,{className:"h-3 w-3 mr-1"}),p.includes(e.user_id)?"Requested":"Add"]}),e.user_id===g?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>U(k===e.id?null:e.id),children:s.jsx(xe,{className:"h-4 w-4"})}),k===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>G(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(B,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",loading:"lazy",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>J(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(r=>r.user_id===g?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(he,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(r=>r.user_id===g?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const r=k!==e.id;if(ee(e.id),r){c.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:i}=await u.rpc("increment_ping_views",{_ping_id:e.id});i?c.error("Home.tsx: Error incrementing ping views",i):c.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(le,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>se(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(be,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(pe,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),k===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(r=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>m(`/profile/${r.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:r.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>m(`/profile/${r.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:r.profiles?.display_name}),r.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(V,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",r.profiles?.username," · ",new Date(r.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(B,{text:r.content})})]})]},r.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:y[e.id]||"",onChange:r=>D({...y,[e.id]:r.target.value}),onFocus:()=>M(e.id),onBlur:()=>M(null),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),z(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>z(e.id),disabled:!y[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${y[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(fe,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:$?"blur-sm pointer-events-none":"",children:s.jsx(ce,{})}),s.jsxs("div",{ref:X,className:"h-10 w-full flex items-center justify-center",children:[v&&_&&s.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[s.jsx(oe,{}),"Loading more pings..."]}),!v&&f.length>0&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),f.length===0&&!w&&s.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{qe as default};
