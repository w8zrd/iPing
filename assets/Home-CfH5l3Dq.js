import{j as t,s as u,u as M,r as l,l as m,a as X,b as Z,c as J}from"./index-D5B3vO8Q.js";import{M as Q,N as ee}from"./Navigation-_NdfecaC.js";import{H as te}from"./Header-vvNVPhLB.js";import{u as se}from"./use-toast-BZ8SEqu7.js";import{X as re}from"./x-DFM2k5ZH.js";import{I as ae,S as ne}from"./send-Cy1OG3Mt.js";import{P as F}from"./textParser-BPKK_KmE.js";import{C as A}from"./check-Dtzjd2fd.js";import{U as ie}from"./user-plus-BNOXFCYr.js";import{c as O}from"./createLucideIcon-BsuKKDQx.js";import{H as oe}from"./heart-DdKI7V2p.js";import{E as le}from"./eye-BA00sszj.js";const ce=O("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const de=O("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),ue=({text:c="Loading..."})=>t.jsx("div",{className:"flex items-center justify-center",children:t.jsxs("div",{className:"text-center animate-fade-in",children:[t.jsx("div",{className:"inline-block h-12 w-12 animate-spin rounded-full border-4 border-muted border-t-primary"}),t.jsx("p",{className:"mt-4 text-muted-foreground",children:c})]})});async function me(c){const r=c.name.split(".").pop(),a=`${(await u.auth.getUser()).data.user?.id}/${Date.now()}.${r}`,{data:n,error:d}=await u.storage.from("media").upload(a,c,{cacheControl:"3600",upsert:!1});if(d)throw new Error(`Storage upload failed: ${d.message}`);const{data:f}=u.storage.from("media").getPublicUrl(n.path);return f.publicUrl}async function fe(c,r){const{data:{user:a}}=await u.auth.getUser();if(!a)throw new Error("User not authenticated.");if(r){const{error:n}=await u.from("likes").delete().eq("ping_id",c).eq("user_id",a.id);if(n)throw new Error(n.message)}else{const{error:n}=await u.from("likes").insert({ping_id:c,user_id:a.id});if(n)throw new Error(n.message)}}async function ge({user_id:c,content:r,image_url:a}){const{data:n,error:d}=await u.from("pings").insert({user_id:c,content:r,image_url:a}).select(`
    *,
    profiles(id, username, display_name, verified, is_admin),
    likes(id, user_id),
    comments(id, user_id)
  `);if(d)throw new Error(d.message);return n}async function he(c){const{data:r,error:a}=await u.from("pings").select(`
      *,
      profiles(id, username, display_name, verified, is_admin),
      likes(id, user_id),
      comments(id, user_id)
    `).eq("id",c).single();if(a)throw new Error(a.message);return r}const pe=({onPostCreated:c})=>{const{user:r}=M(),{toast:a}=se(),[n,d]=l.useState(""),[f,g]=l.useState(null),[h,p]=l.useState(null),[y,k]=l.useState(!1),[j,P]=l.useState(!1),[$,v]=l.useState(!1),C=b=>{const w=b.target.files?.[0]||null;g(w),p(w?URL.createObjectURL(w):null)},_=()=>{g(null),p(null)},S=async b=>{if(b.preventDefault(),!n.trim()&&!f||!r||y||j)return;k(!0);let w;try{f&&(P(!0),w=await me(f),P(!1)),await ge({user_id:r.id,content:n.trim(),image_url:w}),d(""),g(null),p(null),v(!1),m.info("Ping created successfully!"),a({title:"Posted!",description:"Your ping has been sent."}),c&&c()}catch(N){console.error("Post creation error:",N),a({title:"Error posting",description:N.message||"Could not send ping. Please try again.",variant:"destructive"})}finally{k(!1),P(!1)}};return t.jsxs(t.Fragment,{children:[$&&t.jsx("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-40 animate-fade-in",onClick:()=>v(!1)}),t.jsx("div",{className:`w-full max-w-2xl mx-auto bg-white rounded-lg shadow-md p-4 mb-4 transition-all duration-300 ${$?"relative z-50 scale-105":""}`,children:t.jsxs("form",{onSubmit:S,children:[t.jsx("textarea",{id:"content-input",name:"content-input",className:"w-full p-2 border-2 border-gray-200 rounded-lg resize-none focus:outline-none focus:border-blue-500 transition-colors",placeholder:"What's on your mind? Add an image for extra flair!",rows:h?4:2,value:n,onChange:b=>d(b.target.value),onFocus:()=>v(!0)}),h&&t.jsxs("div",{className:"relative mt-3 mb-3",children:[t.jsx("img",{src:h,alt:"Preview",className:"max-h-64 object-cover w-full rounded-lg border"}),t.jsx("button",{type:"button",onClick:_,className:"absolute top-2 right-2 bg-black bg-opacity-50 p-1 rounded-full text-white hover:bg-opacity-75 transition",children:t.jsx(re,{className:"h-4 w-4"})})]}),t.jsxs("div",{className:"flex justify-between items-center mt-3",children:[t.jsxs("label",{htmlFor:"media-upload",className:"cursor-pointer text-blue-500 hover:text-blue-700 transition inline-flex items-center",children:[t.jsx(ae,{className:"h-6 w-6"}),t.jsx("input",{id:"media-upload",name:"media-upload",type:"file",accept:"image/*",onChange:C,className:"hidden",disabled:y||j})]}),t.jsx("button",{type:"button",disabled:y||j||!n.trim()&&!f||!r,onClick:S,className:`px-4 py-2 rounded-lg transition-colors font-semibold text-sm ${y||j||!n.trim()&&!f||!r?"bg-gray-400 cursor-not-allowed text-gray-700 border border-transparent":"bg-blue-500 text-white hover:bg-blue-600 border border-transparent"}`,children:y||j?j?"Uploading...":"Pinging...":"Ping"})]})]})})]})};class xe{async getUserId(){const{data:{session:r}}=await u.auth.getSession();return r?.user?.id??null}async fetchOwnProfile(){const r=await this.getUserId();if(!r)return console.error("User not authenticated to fetch profile."),null;const{data:a,error:n}=await u.from("profiles").select("*").eq("id",r).single();return n?(console.error("Error fetching profile:",n.message),null):a}async updateProfile(r){const a=await this.getUserId();if(!a)return console.error("User not authenticated to update profile."),null;const n={username:r.username,display_name:r.display_name,bio:r.bio,location:r.location,avatar_url:r.avatar_url},d=Object.fromEntries(Object.entries(n).filter(([,h])=>h!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:f,error:g}=await u.from("profiles").update(d).eq("id",a).select().single();return g?(console.error("Error updating profile:",g.message),null):f}async uploadAvatar(r){const a=await this.getUserId();if(!a)return console.error("User not authenticated to upload avatar."),null;r.name.split(".").pop();const n=`avatars/${a}/${Date.now()}_${r.name}`,{error:d}=await u.storage.from("avatars").upload(n,r,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const f=u.storage.from("avatars").getPublicUrl(n).data.publicUrl;return this.updateProfile({avatar_url:f})}async createPost(r,a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to create post."),null;let d;if(a){a.name.split(".").pop();const h=`posts/${n}/${Date.now()}_${a.name}`,{error:p}=await u.storage.from("posts").upload(h,a,{cacheControl:"3600",upsert:!0});if(p)return console.error("Error uploading post image:",p.message),null;d=u.storage.from("posts").getPublicUrl(h).data.publicUrl}const{data:f,error:g}=await u.from("posts").insert({user_id:n,content:r,image_url:d}).select().single();return g?(console.error("Error inserting post:",g.message),null):f}async getPosts(r=20,a=0){const{data:n,error:d}=await u.from("posts").select("*").order("created_at",{ascending:!1}).range(a,a+r-1);return d?(console.error("Error fetching posts:",d.message),null):n}}const be=new xe;function we({threshold:c=0,root:r=null,rootMargin:a="0%",enabled:n=!0}={}){const[d,f]=l.useState(!1),g=l.useRef(null);return l.useEffect(()=>{if(!n)return;const h=new IntersectionObserver(([y])=>{f(y.isIntersecting)},{threshold:c,root:r,rootMargin:a}),p=g.current;return p&&h.observe(p),()=>{p&&h.unobserve(p)}},[c,r,a,n]),{ref:g,isIntersecting:d}}const Le=()=>{const c=X();Z();const[r,a]=J(),n=l.useRef({}),[d,f]=l.useState(null),[g,h]=l.useState([]),[p,y]=l.useState([]),[k,j]=l.useState(!0),[P,$]=l.useState(!1),[v,C]=l.useState(!0),[_,S]=l.useState(0),[b,w]=l.useState(null),[N,R]=l.useState({}),[I,T]=l.useState(null),{user:x}=M(),z=async e=>{if(!x)return;const{error:i}=await u.from("pings").delete().eq("id",e);i?m.error("Error deleting ping",i,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):h(s=>s.filter(o=>o.id!==e))},L=20,E=l.useCallback(async e=>{if(!v&&e)return;const i=e?_*L:0,s=e?$:j;s(!0);const o=await be.getPosts(L,i);o?(C(o.length===L),S(U=>e?U+1:0),h(U=>{if(e){const G=new Set(o.map(H=>H.id));return[...U.filter(H=>!G.has(H.id)),...o]}return o})):(C(!1),m.error("Error fetching posts",{userMessage:"Failed to fetch pings. Please try again."})),s(!1)},[v,_,P]);l.useEffect(()=>{E(!1)},[E]);const{ref:V,isIntersecting:q}=we({threshold:.1});l.useEffect(()=>{q&&v&&!k&&!P&&E(!0)},[q,v,k,P,E]),l.useEffect(()=>{_===0&&g.length>0&&k&&j(!1)},[g,k,_]),l.useEffect(()=>{const e=u.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},async i=>{m.debug("Realtime INSERT received",{new:i.new});try{const s=await he(i.new.id);h(o=>[s,...o]),S(0),C(!0)}catch(s){m.error("Error fetching new ping details",s)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},i=>{m.debug("Realtime UPDATE received",{new:i.new}),i.new.views!==void 0&&i.new.likes===void 0&&i.new.comments===void 0?h(s=>s.map(o=>o.id===i.new.id?{...o,views:i.new.views}:o)):(m.info("Other ping update, refetching page 0."),E(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},i=>{m.debug("Realtime DELETE received",{oldId:i.old.id}),h(s=>s.filter(o=>o.id!==i.old.id))}).subscribe();return()=>{u.removeChannel(e)}},[E]),l.useEffect(()=>{const e=r.get("ping"),i=r.get("openComments")==="true";e&&(f(e),setTimeout(()=>{const s=n.current[e];s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),i&&w(e))},100))},[r,f,w]),l.useEffect(()=>{const e=()=>{d&&(f(null),a({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,a]);const B=async e=>{if(!x){c("/auth");return}const s=g.find(o=>o.id===e)?.likes?.some(o=>o.user_id===x.id)||!1;try{await fe(e,s),m.info(`Home.tsx: Successfully ${s?"unliked":"liked"} ping ${e}.`)}catch(o){const U=o instanceof Error?o.message:"An unknown error occurred.";m.error(`Home.tsx: Error toggling like on ping ${e}`,o,{userMessage:`Failed to change like status. Details: ${U}`,showToast:!0})}E(!1)},D=async e=>{if(!x){c("/auth");return}const i=N[e]?.trim();if(!i)return;m.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:i});const{error:s}=await u.from("comments").insert({user_id:x.id,ping_id:e,content:i});s?m.error("Home.tsx: Error adding comment",s,{userMessage:"Failed to add comment",showToast:!0}):m.info("Home.tsx: Comment added successfully to ping",{pingId:e}),s||(R({...N,[e]:""}),E(!1))},K=async(e,i)=>{if(!x){c("/auth");return}if(p.includes(e))return;m.debug("Home.tsx: Attempting to send friend request",{from:x.id,to:e});const{error:s}=await u.from("friend_requests").insert({from_user_id:x.id,to_user_id:e});s?m.error("Home.tsx: Error sending friend request",s,{userMessage:"Failed to send friend request."}):m.info("Home.tsx: Friend request sent successfully."),s||y([...p,e])},W=e=>{w(b===e?null:e)},Y=async e=>{const i=`${window.location.origin}/?ping=${e.id}`,s=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:s,url:i})}catch(o){o.name!=="AbortError"&&(m.error("Home.tsx: Error sharing ping",o,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(i))}else navigator.clipboard.writeText(i)};return t.jsxs("div",{className:"min-h-screen pb-24",children:[t.jsx("div",{className:I?"blur-sm pointer-events-none":"",children:t.jsx(te,{})}),t.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[t.jsx("div",{className:"mb-8 pt-24 animate-fade-in",children:t.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),t.jsx(pe,{}),t.jsx("div",{className:"space-y-4",children:g.map((e,i)=>t.jsxs("div",{ref:s=>n.current[e.id]=s,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${I&&I!==e.id?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${i*.05}s`},children:[t.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[t.jsx("button",{onClick:()=>c(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("button",{onClick:()=>c(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&t.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:t.jsx(A,{className:"h-3 w-3 text-white stroke-2"})})]}),x&&e.user_id!==x.id&&t.jsxs("button",{onClick:()=>K(e.user_id,e.profiles?.display_name||""),disabled:p.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(ie,{className:"h-3 w-3 mr-1"}),p.includes(e.user_id)?"Requested":"Add"]}),e.user_id===x?.id&&t.jsxs("div",{className:"relative",children:[t.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>w(b===e.id?null:e.id),children:t.jsx(ce,{className:"h-4 w-4"})}),b===e.id&&t.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:t.jsx("button",{onClick:()=>z(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),t.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),t.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:t.jsx(F,{text:e.content})}),e.image_url&&t.jsx("img",{src:e.image_url,alt:"Ping image",loading:"lazy",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),t.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[t.jsxs("button",{onClick:()=>B(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(s=>s.user_id===x?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[t.jsx(oe,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(s=>s.user_id===x?.id)?"fill-destructive":""}`}),t.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),t.jsxs("button",{onClick:async()=>{const s=b!==e.id;if(W(e.id),s){m.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:o}=await u.rpc("increment_ping_views",{_ping_id:e.id});o?m.error("Home.tsx: Error incrementing ping views",o):m.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[t.jsx(Q,{className:"h-5 w-5"}),t.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),t.jsx("button",{onClick:()=>Y(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:t.jsx(de,{className:"h-5 w-5"})}),t.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[t.jsx(le,{className:"h-5 w-5"}),t.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),b===e.id&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(s=>t.jsxs("div",{className:"flex gap-3",children:[t.jsx("button",{onClick:()=>c(`/profile/${s.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:s.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("button",{onClick:()=>c(`/profile/${s.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:s.profiles?.display_name}),s.profiles?.verified&&t.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:t.jsx(A,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),t.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",s.profiles?.username," · ",new Date(s.created_at).toLocaleTimeString()]})]}),t.jsx("p",{className:"text-sm text-foreground/90",children:t.jsx(F,{text:s.content})})]})]},s.id)),t.jsxs("div",{className:"relative mt-4",children:[t.jsx("input",{type:"text",placeholder:"Add a comment...",value:N[e.id]||"",onChange:s=>R({...N,[e.id]:s.target.value}),onFocus:()=>T(e.id),onBlur:()=>T(null),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),D(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),t.jsx("button",{onClick:()=>D(e.id),disabled:!N[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${N[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:t.jsx(ne,{className:"h-5 w-5"})})]})]})]},e.id))})]}),t.jsx("div",{className:`fixed bottom-0 left-0 right-0 z-50 ${I?"blur-sm pointer-events-none":""}`,children:t.jsx(ee,{})}),t.jsxs("div",{ref:V,className:"h-10 w-full flex items-center justify-center",children:[v&&P&&t.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[t.jsx(ue,{}),"Loading more pings..."]}),!v&&g.length>0&&t.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),g.length===0&&!k&&t.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{Le as default};
