import{u as W,a as X,b as G,r as o,c as J,s as l,l as i,j as s}from"./index-BZ5HzKvT.js";import{M as Q,N as Y}from"./Navigation-BYts2Atn.js";import{H as Z}from"./Header-CUICmpnn.js";import{P as A}from"./textParser-BmXaTlZF.js";import{X as ee}from"./x-7okkSn_3.js";import{I as se,S as re}from"./send-DohwrW5W.js";import{C as D}from"./check-BwhrJEhK.js";import{U as te}from"./user-plus-nGG5Ot6x.js";import{c as E}from"./createLucideIcon-HM6xAW1P.js";import{H as ie}from"./heart-DnIO7LYb.js";const ae=E("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const ne=E("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);const oe=E("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),be=()=>{const d=W();X();const[y,P]=G(),C=o.useRef({}),[j,N]=o.useState(null),[H,c]=o.useState([]),[p,U]=o.useState([]),[x,S]=o.useState(""),[T,F]=o.useState(!1),[g,b]=o.useState(null),[m,L]=o.useState({}),[v,R]=o.useState(null),[k,$]=o.useState(!1),[u,_]=o.useState(null),{user:n}=J(),M=async e=>{if(!n)return;const{error:t}=await l.from("pings").delete().eq("id",e);t?i.error("Error deleting ping",t,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):c(r=>r.filter(a=>a.id!==e))};o.useEffect(()=>{h()},[]);const h=async()=>{const{data:e,error:t}=await l.from("pings").select(`
        *,
        profiles!pings_user_id_fkey(id, username, display_name, verified),
        likes(id, user_id),
        comments(
          id,
          user_id,
          content,
          created_at,
          profiles!comments_user_id_fkey(id, username, display_name, verified)
        )
      `).order("created_at",{ascending:!1});!t&&e?(i.info("Pings fetched successfully",{data:e}),c(e)):i.error("Error fetching pings",t,{userMessage:"Failed to fetch pings. Please try again.",showToast:!0})};o.useEffect(()=>{const e=l.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},t=>{i.debug("Realtime INSERT received",{new:t.new}),c(r=>[t.new,...r])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},t=>{i.debug("Realtime UPDATE received",{new:t.new}),t.new.views!==void 0?c(r=>r.map(a=>a.id===t.new.id?{...a,views:t.new.views}:a)):(i.info("Other ping update, refetching all pings."),h())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},t=>{i.debug("Realtime DELETE received",{oldId:t.old.id}),c(r=>r.filter(a=>a.id!==t.old.id))}).subscribe();return()=>{l.removeChannel(e)}},[]),o.useEffect(()=>{const e=y.get("ping"),t=y.get("openComments")==="true";e&&(N(e),setTimeout(()=>{const r=C.current[e];r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),t&&b(e))},100))},[y,N,b]),o.useEffect(()=>{const e=()=>{j&&(N(null),P({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[j,P]);const I=e=>{const t=e.target.files?.[0];if(t){const r=new FileReader;r.onloadend=()=>{_(r.result),i.debug("Image loaded for ping preview")},r.readAsDataURL(t)}},z=async()=>{if(!n){d("/auth");return}if(!(!x.trim()&&!u)){F(!0),i.debug("Home.tsx: Attempting to create new ping",{newPing:x,pingImage:u});try{const{error:e}=await l.from("pings").insert({user_id:n.id,content:x,image_url:u||void 0});e?i.error("Home.tsx: Error creating ping",e,{userMessage:"Failed to ping. Please try again.",showToast:!0}):(i.info("Home.tsx: Ping created successfully."),S(""),_(null),h())}catch(e){i.error("Home.tsx: Unexpected error creating ping",e,{userMessage:"An unexpected error occurred while creating ping.",showToast:!0})}finally{F(!1)}}},V=async e=>{if(!n){d("/auth");return}const t=H.find(a=>a.id===e);if(t?.likes?.some(a=>a.user_id===n.id)){i.debug("Home.tsx: User unliking ping",{pingId:e});const a=t?.likes?.find(f=>f.user_id===n.id)?.id,{error:w}=await l.from("likes").delete().eq("id",a);w&&i.error("Home.tsx: Error unliking ping",w)}else{i.debug("Home.tsx: User liking ping",{pingId:e});const{error:a}=await l.from("likes").insert({user_id:n.id,post_id:e});a&&i.error("Home.tsx: Error liking ping",a)}h()},q=async e=>{if(!n){d("/auth");return}const t=m[e]?.trim();if(!t)return;i.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:t});const{error:r}=await l.from("comments").insert({user_id:n.id,ping_id:e,content:t});r?i.error("Home.tsx: Error adding comment",r,{userMessage:"Failed to add comment",showToast:!0}):i.info("Home.tsx: Comment added successfully to ping",{pingId:e}),r||(L({...m,[e]:""}),h())},B=async(e,t)=>{if(!n){d("/auth");return}if(p.includes(e))return;i.debug("Home.tsx: Attempting to send friend request",{from:n.id,to:e});const{error:r}=await l.from("friend_requests").insert({from_user_id:n.id,to_user_id:e});r?i.error("Home.tsx: Error sending friend request",r,{userMessage:"Failed to send friend request."}):i.info("Home.tsx: Friend request sent successfully."),r||U([...p,e])},K=e=>{b(g===e?null:e)},O=async e=>{const t=`${window.location.origin}/?ping=${e.id}`,r=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:r,url:t})}catch(a){a.name!=="AbortError"&&(i.error("Home.tsx: Error sharing ping",a,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(t))}else navigator.clipboard.writeText(t)};return s.jsxs("div",{className:"min-h-screen pb-32",children:[s.jsx("div",{className:v||k?"blur-sm pointer-events-none":"",children:s.jsx(Z,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${k?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:x,onChange:e=>S(e.target.value),onFocus:()=>$(!0),onBlur:()=>$(!1),className:"min-h-[100px] rounded-2xl border-border/50 resize-none focus-visible:ring-0 focus-visible:ring-offset-0 focus-visible:border-primary transition-apple mb-4 p-2 w-full bg-transparent"}),u&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:u,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>_(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(ee,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:I,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(se,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:z,disabled:T||!x.trim()&&!u,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 font-semibold transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:T?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:H.map((e,t)=>s.jsxs("div",{ref:r=>C.current[e.id]=r,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${v&&v!==e.id||k?"blur-sm pointer-events-none":""} ${j===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${t*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>d(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>d(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(D,{className:"h-3 w-3 text-white stroke-2"})})]}),n&&e.user_id!==n.id&&s.jsxs("button",{onClick:()=>B(e.user_id,e.profiles?.display_name||""),disabled:p.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(te,{className:"h-3 w-3 mr-1"}),p.includes(e.user_id)?"Requested":"Add"]}),e.user_id===n?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>b(g===e.id?null:e.id),children:s.jsx(ae,{className:"h-4 w-4"})}),g===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>M(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(A,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>V(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(r=>r.user_id===n?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(ie,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(r=>r.user_id===n?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const r=g!==e.id;if(K(e.id),r){i.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:a}=await l.rpc("increment_ping_views",{_ping_id:e.id});a?i.error("Home.tsx: Error incrementing ping views",a):(i.info("Home.tsx: Ping views incremented successfully",{pingId:e.id}),c(w=>w.map(f=>f.id===e.id?{...f,views:f.views+1}:f)))}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(Q,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>O(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(oe,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(ne,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),g===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(r=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>d(`/profile/${r.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:r.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>d(`/profile/${r.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:r.profiles?.display_name}),r.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(D,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",r.profiles?.username," · ",new Date(r.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(A,{text:r.content})})]})]},r.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:m[e.id]||"",onChange:r=>L({...m,[e.id]:r.target.value}),onFocus:()=>R(e.id),onBlur:()=>R(null),onKeyDown:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),q(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>q(e.id),disabled:!m[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${m[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(re,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:v?"blur-sm pointer-events-none":"",children:s.jsx(Y,{})})]})};export{be as default};
