import{j as s,s as m,r as l,u as ne,a as ie,b as oe,c as le,l as u}from"./index-BjYxiFuP.js";import{M as ce,N as de}from"./Navigation-CS1MzQOw.js";import{H as ue}from"./Header-B5X8EHly.js";import{P as K}from"./textParser-DefPvLj7.js";import{X as me}from"./x-CtfVQlE_.js";import{I as fe,S as ge}from"./send-BcrsZ0Nq.js";import{C as W}from"./check-DKluYzb6.js";import{U as he}from"./user-plus-D0KWh9QG.js";import{c as G}from"./createLucideIcon-Cqy9Dfsr.js";import{H as pe}from"./heart-CeXyzzrE.js";import{E as xe}from"./eye-B7c1IeV_.js";const be=G("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);const we=G("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),ve=({text:c="Loading..."})=>s.jsx("div",{className:"flex items-center justify-center",children:s.jsxs("div",{className:"text-center animate-fade-in",children:[s.jsx("div",{className:"inline-block h-12 w-12 animate-spin rounded-full border-4 border-muted border-t-primary"}),s.jsx("p",{className:"mt-4 text-muted-foreground",children:c})]})});async function ye(c,a){const{data:{user:n}}=await m.auth.getUser();if(!n)throw new Error("User not authenticated.");if(a){const{error:i}=await m.from("likes").delete().eq("ping_id",c).eq("user_id",n.id);if(i)throw new Error(i.message)}else{const{error:i}=await m.from("likes").insert({ping_id:c,user_id:n.id});if(i)throw new Error(i.message)}}async function je({user_id:c,content:a,image_url:n}){const{data:i,error:d}=await m.from("pings").insert({user_id:c,content:a,image_url:n}).select(`
    *,
    profiles(id, username, display_name, verified, is_admin),
    likes(id, user_id),
    comments(id, user_id)
  `);if(d)throw new Error(d.message);return i}async function Ne(c){const{data:a,error:n}=await m.from("pings").select(`
      *,
      profiles(id, username, display_name, verified, is_admin),
      likes(id, user_id),
      comments(id, user_id)
    `).eq("id",c).single();if(n)throw new Error(n.message);return a}async function ke(c){const a=c.name.split(".").pop(),n=`${(await m.auth.getUser()).data.user?.id}/${Date.now()}.${a}`,{data:i,error:d}=await m.storage.from("media").upload(n,c,{cacheControl:"3600",upsert:!1});if(d)throw new Error(`Storage upload failed: ${d.message}`);const{data:p}=m.storage.from("media").getPublicUrl(i.path);return p.publicUrl}class Ee{async getUserId(){const{data:{session:a}}=await m.auth.getSession();return a?.user?.id??null}async fetchOwnProfile(){const a=await this.getUserId();if(!a)return console.error("User not authenticated to fetch profile."),null;const{data:n,error:i}=await m.from("profiles").select("*").eq("id",a).single();return i?(console.error("Error fetching profile:",i.message),null):n}async updateProfile(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to update profile."),null;const i={username:a.username,display_name:a.display_name,bio:a.bio,location:a.location,avatar_url:a.avatar_url},d=Object.fromEntries(Object.entries(i).filter(([,h])=>h!=null));if(Object.keys(d).length===0)return console.warn("No valid updates provided for profile."),this.fetchOwnProfile();const{data:p,error:f}=await m.from("profiles").update(d).eq("id",n).select().single();return f?(console.error("Error updating profile:",f.message),null):p}async uploadAvatar(a){const n=await this.getUserId();if(!n)return console.error("User not authenticated to upload avatar."),null;a.name.split(".").pop();const i=`avatars/${n}/${Date.now()}_${a.name}`,{error:d}=await m.storage.from("avatars").upload(i,a,{cacheControl:"3600",upsert:!0});if(d)return console.error("Error uploading avatar:",d.message),null;const p=m.storage.from("avatars").getPublicUrl(i).data.publicUrl;return this.updateProfile({avatar_url:p})}async createPost(a,n){const i=await this.getUserId();if(!i)return console.error("User not authenticated to create post."),null;let d;if(n){n.name.split(".").pop();const h=`posts/${i}/${Date.now()}_${n.name}`,{error:x}=await m.storage.from("posts").upload(h,n,{cacheControl:"3600",upsert:!0});if(x)return console.error("Error uploading post image:",x.message),null;d=m.storage.from("posts").getPublicUrl(h).data.publicUrl}const{data:p,error:f}=await m.from("posts").insert({user_id:i,content:a,image_url:d}).select().single();return f?(console.error("Error inserting post:",f.message),null):p}async getPosts(a=20,n=0){const{data:i,error:d}=await m.from("posts").select("*").order("created_at",{ascending:!1}).range(n,n+a-1);return d?(console.error("Error fetching posts:",d.message),null):i}}const Pe=new Ee;function _e({threshold:c=0,root:a=null,rootMargin:n="0%",enabled:i=!0}={}){const[d,p]=l.useState(!1),f=l.useRef(null);return l.useEffect(()=>{if(!i)return;const h=new IntersectionObserver(([L])=>{p(L.isIntersecting)},{threshold:c,root:a,rootMargin:n}),x=f.current;return x&&h.observe(x),()=>{x&&h.unobserve(x)}},[c,a,n,i]),{ref:f,isIntersecting:d}}const Fe=()=>{const c=ne();ie();const[a,n]=oe(),i=l.useRef({}),[d,p]=l.useState(null),[f,h]=l.useState([]),[x,L]=l.useState([]),[N,F]=l.useState(""),[w,P]=l.useState(!0),[_,X]=l.useState(!1),[v,C]=l.useState(!0),[S,T]=l.useState(0),[k,U]=l.useState(null),[y,M]=l.useState({}),[$,O]=l.useState(null),[j,z]=l.useState(!1),[I,D]=l.useState(null),[H,R]=l.useState(null);l.useEffect(()=>(j?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[j]);const{user:g}=le(),Y=async e=>{if(!g)return;const{error:r}=await m.from("pings").delete().eq("id",e);r?u.error("Error deleting ping",r,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):h(t=>t.filter(o=>o.id!==e))},q=20,b=l.useCallback(async e=>{if(!v&&e)return;const r=e?S*q:0,t=e?X:P;t(!0);const o=await Pe.getPosts(q,r);o?(C(o.length===q),T(E=>e?E+1:0),h(E=>{if(e){const ae=new Set(o.map(A=>A.id));return[...E.filter(A=>!ae.has(A.id)),...o]}return o})):(C(!1),u.error("Error fetching posts",{userMessage:"Failed to fetch pings. Please try again."})),t(!1)},[v,S,_]);l.useEffect(()=>{b(!1)},[b]);const{ref:Z,isIntersecting:V}=_e({threshold:.1});l.useEffect(()=>{V&&v&&!w&&!_&&b(!0)},[V,v,w,_,b]),l.useEffect(()=>{S===0&&f.length>0&&w&&P(!1)},[f,w,S]),l.useEffect(()=>{const e=m.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},async r=>{u.debug("Realtime INSERT received",{new:r.new});try{const t=await Ne(r.new.id);h(o=>[t,...o]),T(0),C(!0)}catch(t){u.error("Error fetching new ping details",t)}}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},r=>{u.debug("Realtime UPDATE received",{new:r.new}),r.new.views!==void 0&&r.new.likes===void 0&&r.new.comments===void 0?h(t=>t.map(o=>o.id===r.new.id?{...o,views:r.new.views}:o)):(u.info("Other ping update, refetching page 0."),b(!1))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},r=>{u.debug("Realtime DELETE received",{oldId:r.old.id}),h(t=>t.filter(o=>o.id!==r.old.id))}).subscribe();return()=>{m.removeChannel(e)}},[b]),l.useEffect(()=>{const e=a.get("ping"),r=a.get("openComments")==="true";e&&(p(e),setTimeout(()=>{const t=i.current[e];t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),r&&U(e))},100))},[a,p,U]),l.useEffect(()=>{const e=()=>{d&&(p(null),n({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d,n]);const J=e=>{const r=e.target.files?.[0];if(r){R(r);const t=new FileReader;t.onloadend=()=>{D(t.result),u.debug("Image loaded for ping preview")},t.readAsDataURL(r)}},Q=async()=>{if(!g){c("/auth");return}if(!(!N.trim()&&!H&&!I)){P(!0),u.debug("Home.tsx: Attempting to create new ping",{newPing:N,hasImage:!!H});try{let e;H&&(e=await ke(H)),await je({user_id:g.id,content:N,image_url:e}),u.info("Home.tsx: Ping created successfully."),F(""),D(null),R(null),T(0),C(!0)}catch(e){const r=e instanceof Error?e.message:"An unknown error occurred.";u.error("Home.tsx: Error creating ping",e,{userMessage:`Failed to ping. Please try again. Details: ${r}`,showToast:!0})}finally{P(!1)}}},ee=async e=>{if(!g){c("/auth");return}const t=f.find(o=>o.id===e)?.likes?.some(o=>o.user_id===g.id)||!1;try{await ye(e,t),u.info(`Home.tsx: Successfully ${t?"unliked":"liked"} ping ${e}.`)}catch(o){const E=o instanceof Error?o.message:"An unknown error occurred.";u.error(`Home.tsx: Error toggling like on ping ${e}`,o,{userMessage:`Failed to change like status. Details: ${E}`,showToast:!0})}b(!1)},B=async e=>{if(!g){c("/auth");return}const r=y[e]?.trim();if(!r)return;u.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:r});const{error:t}=await m.from("comments").insert({user_id:g.id,ping_id:e,content:r});t?u.error("Home.tsx: Error adding comment",t,{userMessage:"Failed to add comment",showToast:!0}):u.info("Home.tsx: Comment added successfully to ping",{pingId:e}),t||(M({...y,[e]:""}),b(!1))},se=async(e,r)=>{if(!g){c("/auth");return}if(x.includes(e))return;u.debug("Home.tsx: Attempting to send friend request",{from:g.id,to:e});const{error:t}=await m.from("friend_requests").insert({from_user_id:g.id,to_user_id:e});t?u.error("Home.tsx: Error sending friend request",t,{userMessage:"Failed to send friend request."}):u.info("Home.tsx: Friend request sent successfully."),t||L([...x,e])},te=e=>{U(k===e?null:e)},re=async e=>{const r=`${window.location.origin}/?ping=${e.id}`,t=`Check out this ping from ${e.profiles?.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:t,url:r})}catch(o){o.name!=="AbortError"&&(u.error("Home.tsx: Error sharing ping",o,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(r))}else navigator.clipboard.writeText(r)};return s.jsxs("div",{className:"min-h-screen pb-24",children:[s.jsx("div",{className:$||j?"blur-sm pointer-events-none":"",children:s.jsx(ue,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${j?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),j&&s.jsx("div",{className:"fixed inset-0 bg-background/80 backdrop-blur-sm z-40 animate-fade-in",onClick:()=>z(!1)}),s.jsxs("div",{className:`glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in transition-all duration-300 ${j?"relative z-50 scale-105":""}`,children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:N,onChange:e=>F(e.target.value),onFocus:()=>z(!0),className:"min-h-[100px] rounded-2xl border-2 border-gray-300 resize-none focus:outline-none focus:border-blue-500 transition-all mb-4 p-2 w-full bg-transparent"}),I&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:I,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>{D(null),R(null)},className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(me,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:J,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple flex items-center justify-center",onClick:e=>{e.preventDefault(),e.currentTarget.previousElementSibling?.click()},children:[s.jsx(fe,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:Q,disabled:w||!N.trim()&&!I,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 text-white font-bold transition-all shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed",children:w?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:f.map((e,r)=>s.jsxs("div",{ref:t=>i.current[e.id]=t,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${$&&$!==e.id?"blur-sm pointer-events-none":""} ${d===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${r*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>c(`/profile/${e.profiles?.username}`),className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:e.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>c(`/profile/${e.profiles?.username}`),className:"font-semibold hover:text-primary transition-apple",children:e.profiles?.display_name}),e.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(W,{className:"h-3 w-3 text-white stroke-2"})})]}),g&&e.user_id!==g.id&&s.jsxs("button",{onClick:()=>se(e.user_id,e.profiles?.display_name||""),disabled:x.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(he,{className:"h-3 w-3 mr-1"}),x.includes(e.user_id)?"Requested":"Add"]}),e.user_id===g?.id&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>U(k===e.id?null:e.id),children:s.jsx(be,{className:"h-4 w-4"})}),k===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>Y(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",e.profiles?.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(K,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",loading:"lazy",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>ee(e.id),className:`flex items-center gap-2 transition-apple group ${e.likes?.some(t=>t.user_id===g?.id)?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(pe,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${e.likes?.some(t=>t.user_id===g?.id)?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:e.likes?.length||0})]}),s.jsxs("button",{onClick:async()=>{const t=k!==e.id;if(te(e.id),t){u.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:o}=await m.rpc("increment_ping_views",{_ping_id:e.id});o?u.error("Home.tsx: Error incrementing ping views",o):u.info("Home.tsx: Ping views successfully updated via RPC. Realtime listener will update state.")}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(ce,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.comments?.length||0})]}),s.jsx("button",{onClick:()=>re(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(we,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(xe,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),k===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(t=>s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>c(`/profile/${t.profiles?.username}`),className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:t.profiles?.display_name?.charAt(0).toUpperCase()||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>c(`/profile/${t.profiles?.username}`),className:"font-semibold text-sm hover:text-primary transition-apple",children:t.profiles?.display_name}),t.profiles?.verified&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(W,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",t.profiles?.username," · ",new Date(t.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(K,{text:t.content})})]})]},t.id)),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:y[e.id]||"",onChange:t=>M({...y,[e.id]:t.target.value}),onFocus:()=>O(e.id),onBlur:()=>O(null),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),B(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>B(e.id),disabled:!y[e.id]?.trim(),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${y[e.id]?.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(ge,{className:"h-5 w-5"})})]})]})]},e.id))})]}),s.jsx("div",{className:`fixed bottom-0 left-0 right-0 z-50 ${$?"blur-sm pointer-events-none":""}`,children:s.jsx(de,{})}),s.jsxs("div",{ref:Z,className:"h-10 w-full flex items-center justify-center",children:[v&&_&&s.jsxs("div",{className:"flex items-center gap-2 text-primary font-medium",children:[s.jsx(ve,{}),"Loading more pings..."]}),!v&&f.length>0&&s.jsx("p",{className:"text-sm text-muted-foreground",children:"You've reached the end of the feed."}),f.length===0&&!w&&s.jsx("p",{className:"text-center text-muted-foreground pt-4",children:"No pings found. Be the first to post!"})]})]})};export{Fe as default};
