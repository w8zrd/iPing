import{u as oe,a as le,b as de,r as l,c as ce,s as c,l as a,j as s}from"./index-DI89oLvi.js";import{M as me,N as ue}from"./Navigation-CCuSAfZq.js";import{H as fe}from"./Header-D2yrwniz.js";import{P as Q}from"./textParser-Bya1rKIJ.js";import{X as xe}from"./x-CHZwQEb0.js";import{I as ge,S as he}from"./send-Dmn57hO1.js";import{C as Y}from"./check-DN1bmkHn.js";import{U as pe}from"./user-plus-pFQmeAU3.js";import{c as R}from"./createLucideIcon-CJ3bZHtC.js";import{H as be}from"./heart-DhN3wily.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=R("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=R("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=R("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]),Fe=()=>{const m=oe();le();const[H,$]=de(),q=l.useRef({}),[S,T]=l.useState(null),[A,x]=l.useState([]),[k,Z]=l.useState([]),[p,D]=l.useState(""),[U,M]=l.useState(!1),[b,_]=l.useState(null),[g,I]=l.useState({}),[E,z]=l.useState(null),[F,V]=l.useState(!1),[h,L]=l.useState(null),{user:n}=ce(),ee=async e=>{if(!n)return;const{error:r}=await c.from("pings").delete().eq("id",e);r?a.error("Error deleting ping",r,{userMessage:"Failed to delete ping. Please try again.",showToast:!0}):x(i=>i.filter(o=>o.id!==e))};l.useEffect(()=>{v()},[]);const v=async()=>{const{data:e,error:r}=await c.from("pings").select(`
        *,
        profiles!pings_user_id_fkey(id, username, display_name, verified),
        likes(id, user_id),
        comments(
          id,
          user_id,
          content,
          created_at,
          profiles!comments_user_id_fkey(id, username, display_name, verified)
        )
      `).order("created_at",{ascending:!1});!r&&e?(a.info("Pings fetched successfully",{data:e}),x(e)):a.error("Error fetching pings",r,{userMessage:"Failed to fetch pings. Please try again.",showToast:!0})};l.useEffect(()=>{const e=c.channel("pings-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"pings"},r=>{a.debug("Realtime INSERT received",{new:r.new}),x(i=>[r.new,...i])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"pings"},r=>{a.debug("Realtime UPDATE received",{new:r.new}),r.new.views!==void 0?x(i=>i.map(o=>o.id===r.new.id?{...o,views:r.new.views}:o)):(a.info("Other ping update, refetching all pings."),v())}).on("postgres_changes",{event:"DELETE",schema:"public",table:"pings"},r=>{a.debug("Realtime DELETE received",{oldId:r.old.id}),x(i=>i.filter(o=>o.id!==r.old.id))}).subscribe();return()=>{c.removeChannel(e)}},[]),l.useEffect(()=>{const e=H.get("ping"),r=H.get("openComments")==="true";e&&(T(e),setTimeout(()=>{const i=q.current[e];i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),r&&_(e))},100))},[H,T,_]),l.useEffect(()=>{const e=()=>{S&&(T(null),$({},{replace:!0}))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[S,$]);const se=e=>{var i;const r=(i=e.target.files)==null?void 0:i[0];if(r){const o=new FileReader;o.onloadend=()=>{L(o.result),a.debug("Image loaded for ping preview")},o.readAsDataURL(r)}},re=async()=>{if(!n){m("/auth");return}if(!(!p.trim()&&!h)){M(!0),a.debug("Home.tsx: Attempting to create new ping",{newPing:p,pingImage:h});try{const{error:e}=await c.from("pings").insert({user_id:n.id,content:p,image_url:h||void 0});e?a.error("Home.tsx: Error creating ping",e,{userMessage:"Failed to ping. Please try again.",showToast:!0}):(a.info("Home.tsx: Ping created successfully."),D(""),L(null),v())}catch(e){a.error("Home.tsx: Unexpected error creating ping",e,{userMessage:"An unexpected error occurred while creating ping.",showToast:!0})}finally{M(!1)}}},te=async e=>{var o,u,w;if(!n){m("/auth");return}const r=A.find(d=>d.id===e);if((o=r==null?void 0:r.likes)==null?void 0:o.some(d=>d.user_id===n.id)){a.debug("Home.tsx: User unliking ping",{pingId:e});const d=(w=(u=r==null?void 0:r.likes)==null?void 0:u.find(P=>P.user_id===n.id))==null?void 0:w.id,{error:y}=await c.from("likes").delete().eq("id",d);y&&a.error("Home.tsx: Error unliking ping",y)}else{a.debug("Home.tsx: User liking ping",{pingId:e});const{error:d}=await c.from("likes").insert({user_id:n.id,post_id:e});d&&a.error("Home.tsx: Error liking ping",d)}v()},B=async e=>{var o;if(!n){m("/auth");return}const r=(o=g[e])==null?void 0:o.trim();if(!r)return;a.debug("Home.tsx: Attempting to add comment to ping",{pingId:e,content:r});const{error:i}=await c.from("comments").insert({user_id:n.id,ping_id:e,content:r});i?a.error("Home.tsx: Error adding comment",i,{userMessage:"Failed to add comment",showToast:!0}):a.info("Home.tsx: Comment added successfully to ping",{pingId:e}),i||(I({...g,[e]:""}),v())},ie=async(e,r)=>{if(!n){m("/auth");return}if(k.includes(e))return;a.debug("Home.tsx: Attempting to send friend request",{from:n.id,to:e});const{error:i}=await c.from("friend_requests").insert({from_user_id:n.id,to_user_id:e});i?a.error("Home.tsx: Error sending friend request",i,{userMessage:"Failed to send friend request."}):a.info("Home.tsx: Friend request sent successfully."),i||Z([...k,e])},ae=e=>{_(b===e?null:e)},ne=async e=>{var o;const r=`${window.location.origin}/?ping=${e.id}`,i=`Check out this ping from ${(o=e.profiles)==null?void 0:o.display_name} on iPing!`;if(navigator.share)try{await navigator.share({title:"iPing Ping",text:i,url:r})}catch(u){u.name!=="AbortError"&&(a.error("Home.tsx: Error sharing ping",u,{userMessage:"Failed to share ping.",showToast:!0}),navigator.clipboard.writeText(r))}else navigator.clipboard.writeText(r)};return s.jsxs("div",{className:"min-h-screen pb-32",children:[s.jsx("div",{className:E||F?"blur-sm pointer-events-none":"",children:s.jsx(fe,{})}),s.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[s.jsx("div",{className:`mb-8 pt-24 animate-fade-in ${F?"blur-sm pointer-events-none":""}`,children:s.jsx("p",{className:"text-muted-foreground",children:"Connect with friends"})}),s.jsxs("div",{className:"glass-strong rounded-3xl p-6 mb-6 shadow-lg animate-scale-in",children:[s.jsx("textarea",{placeholder:"What's on your mind?",value:p,onChange:e=>D(e.target.value),onFocus:()=>V(!0),onBlur:()=>V(!1),className:"min-h-[100px] rounded-2xl border-border/50 resize-none focus-visible:ring-0 focus-visible:ring-offset-0 focus-visible:border-primary transition-apple mb-4 p-2 w-full bg-transparent"}),h&&s.jsxs("div",{className:"relative mb-4",children:[s.jsx("img",{src:h,alt:"Upload preview",className:"rounded-2xl max-h-64 w-full object-cover"}),s.jsx("button",{onClick:()=>L(null),className:"absolute top-2 right-2 bg-background/80 backdrop-blur-sm rounded-full p-1.5 hover:bg-background transition-apple",children:s.jsx(xe,{className:"h-4 w-4"})})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("label",{className:"flex-1",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:se,className:"hidden"}),s.jsxs("button",{type:"button",className:"w-full h-12 rounded-2xl border border-border/50 bg-background/50 hover:bg-background/80 transition-apple",onClick:e=>{var r;e.preventDefault(),(r=e.currentTarget.previousElementSibling)==null||r.click()},children:[s.jsx(ge,{className:"h-5 w-5 mr-2"}),"Image"]})]}),s.jsx("button",{onClick:re,disabled:U||!p.trim()&&!h,className:"flex-1 h-12 rounded-2xl bg-primary hover:bg-primary/90 font-semibold transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:U?"Pinging...":"Ping"})]})]}),s.jsx("div",{className:"space-y-4",children:A.map((e,r)=>{var i,o,u,w,d,y,P,K,O,W,X;return s.jsxs("div",{ref:t=>q.current[e.id]=t,className:`glass rounded-3xl p-6 shadow-md hover-lift animate-fade-in transition-all ${E&&E!==e.id||F?"blur-sm pointer-events-none":""} ${S===e.id?"ring-4 ring-primary ring-offset-2 ring-offset-background":""}`,style:{animationDelay:`${r*.05}s`},children:[s.jsxs("div",{className:"flex items-start gap-3 mb-3",children:[s.jsx("button",{onClick:()=>{var t;return m(`/profile/${(t=e.profiles)==null?void 0:t.username}`)},className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary/50 flex items-center justify-center text-white font-semibold text-sm hover:scale-105 transition-apple",children:((o=(i=e.profiles)==null?void 0:i.display_name)==null?void 0:o.charAt(0).toUpperCase())||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>{var t;return m(`/profile/${(t=e.profiles)==null?void 0:t.username}`)},className:"font-semibold hover:text-primary transition-apple",children:(u=e.profiles)==null?void 0:u.display_name}),((w=e.profiles)==null?void 0:w.verified)&&s.jsx("div",{className:"flex items-center justify-center w-4 h-4 bg-primary rounded-full",children:s.jsx(Y,{className:"h-3 w-3 text-white stroke-2"})})]}),n&&e.user_id!==n.id&&s.jsxs("button",{onClick:()=>{var t;return ie(e.user_id,((t=e.profiles)==null?void 0:t.display_name)||"")},disabled:k.includes(e.user_id),className:"h-6 text-xs ml-auto rounded-full px-3 py-1 border border-border/50 bg-background/50 hover:bg-background/80 transition-apple disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx(pe,{className:"h-3 w-3 mr-1"}),k.includes(e.user_id)?"Requested":"Add"]}),e.user_id===(n==null?void 0:n.id)&&s.jsxs("div",{className:"relative",children:[s.jsx("button",{className:"h-8 w-8 rounded-full ml-auto hover:bg-background/80 transition-apple",onClick:()=>_(b===e.id?null:e.id),children:s.jsx(ve,{className:"h-4 w-4"})}),b===e.id&&s.jsx("div",{className:"absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10",children:s.jsx("button",{onClick:()=>ee(e.id),className:"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",children:"Delete Ping"})})]})]}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["@",(d=e.profiles)==null?void 0:d.username," · ",new Date(e.created_at).toLocaleString()]})]})]}),s.jsx("p",{className:"mb-4 text-foreground/90 break-words",children:s.jsx(Q,{text:e.content})}),e.image_url&&s.jsx("img",{src:e.image_url,alt:"Ping image",className:"rounded-2xl w-full mb-4 max-h-96 object-cover"}),s.jsxs("div",{className:"flex items-center gap-6 mb-4",children:[s.jsxs("button",{onClick:()=>te(e.id),className:`flex items-center gap-2 transition-apple group ${(y=e.likes)!=null&&y.some(t=>t.user_id===(n==null?void 0:n.id))?"text-destructive":"text-muted-foreground hover:text-destructive"}`,children:[s.jsx(be,{className:`h-5 w-5 group-hover:animate-bounce-subtle ${(P=e.likes)!=null&&P.some(t=>t.user_id===(n==null?void 0:n.id))?"fill-destructive":""}`}),s.jsx("span",{className:"text-sm font-medium",children:((K=e.likes)==null?void 0:K.length)||0})]}),s.jsxs("button",{onClick:async()=>{const t=b!==e.id;if(ae(e.id),t){a.debug("Home.tsx: Incrementing views for ping",{pingId:e.id});const{error:j}=await c.rpc("increment_ping_views",{_ping_id:e.id});j?a.error("Home.tsx: Error incrementing ping views",j):(a.info("Home.tsx: Ping views incremented successfully",{pingId:e.id}),x(C=>C.map(f=>f.id===e.id?{...f,views:f.views+1}:f)))}},className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:[s.jsx(me,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:((O=e.comments)==null?void 0:O.length)||0})]}),s.jsx("button",{onClick:()=>ne(e),className:"flex items-center gap-2 text-muted-foreground hover:text-primary transition-apple",children:s.jsx(ye,{className:"h-5 w-5"})}),s.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground ml-auto",children:[s.jsx(we,{className:"h-5 w-5"}),s.jsx("span",{className:"text-sm font-medium",children:e.views.toLocaleString()})]})]}),b===e.id&&s.jsxs("div",{className:"mt-4 pt-4 border-t border-border/50 animate-fade-in space-y-4",children:[(e.comments||[]).map(t=>{var j,C,f,G,J;return s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>{var N;return m(`/profile/${(N=t.profiles)==null?void 0:N.username}`)},className:"w-8 h-8 rounded-full bg-gradient-to-br from-secondary to-muted flex items-center justify-center text-foreground font-semibold text-xs hover:scale-105 transition-apple",children:((C=(j=t.profiles)==null?void 0:j.display_name)==null?void 0:C.charAt(0).toUpperCase())||"U"}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx("button",{onClick:()=>{var N;return m(`/profile/${(N=t.profiles)==null?void 0:N.username}`)},className:"font-semibold text-sm hover:text-primary transition-apple",children:(f=t.profiles)==null?void 0:f.display_name}),((G=t.profiles)==null?void 0:G.verified)&&s.jsx("div",{className:"flex items-center justify-center w-3.5 h-3.5 bg-primary rounded-full",children:s.jsx(Y,{className:"h-2.5 w-2.5 text-white stroke-2"})})]}),s.jsxs("span",{className:"text-xs text-muted-foreground",children:["@",(J=t.profiles)==null?void 0:J.username," · ",new Date(t.created_at).toLocaleTimeString()]})]}),s.jsx("p",{className:"text-sm text-foreground/90",children:s.jsx(Q,{text:t.content})})]})]},t.id)}),s.jsxs("div",{className:"relative mt-4",children:[s.jsx("input",{type:"text",placeholder:"Add a comment...",value:g[e.id]||"",onChange:t=>I({...g,[e.id]:t.target.value}),onFocus:()=>z(e.id),onBlur:()=>z(null),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),B(e.id))},className:"h-12 pr-12 rounded-3xl glass-strong border-border/50 transition-apple px-4 w-full bg-transparent focus:outline-none"}),s.jsx("button",{onClick:()=>B(e.id),disabled:!((W=g[e.id])!=null&&W.trim()),className:`absolute right-4 top-1/2 -translate-y-1/2 transition-apple ${(X=g[e.id])!=null&&X.trim()?"text-primary hover:scale-110":"text-muted-foreground opacity-50 cursor-not-allowed"}`,children:s.jsx(he,{className:"h-5 w-5"})})]})]})]},e.id)})})]}),s.jsx("div",{className:E?"blur-sm pointer-events-none":"",children:s.jsx(ue,{})})]})};export{Fe as default};
